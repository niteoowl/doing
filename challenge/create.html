<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Doing! - 챌린지 생성</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --c-acc: #1E90FF; --c-lite: #E6F7FF; --c-bord: #e8e8e8; --c-dan: #ff4d4f; }
        * { box-sizing: border-box; font-family: 'Pretendard Variable', sans-serif; }
        body { margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; color: #000; -webkit-tap-highlight-color: transparent; }
        #app-container { width: 100%; display: flex; flex-direction: column; position: relative; min-height: 100vh; opacity: 0; transition: opacity 0.5s; }
        #app-container.font-loaded { opacity: 1; }
        .h { display: none !important; }
        .i { cursor: pointer; transition: 0.2s; }
        .i:active { transform: scale(0.98); }

        @media (min-width: 640px) { body { align-items: flex-start; justify-content: center; } #app-container { max-width: 600px; box-shadow: none; } .v { padding: 2rem 1.5rem; } .h-main { padding: 0.5rem 1.5rem; } }
        @media (max-width: 639px) { .h-main { padding: 0.5rem 1.5rem; } .v { padding: 1.5rem 1.5rem; } }

        .h-main { display: flex; justify-content: flex-start; align-items: center; background-color: #fff; border-bottom: 1px solid var(--c-bord); position: sticky; top: 0; z-index: 10; }
        .h-main-title { font-size: 1.2rem; font-weight: 600; flex-grow: 1; text-align: center; margin-right: 40px; }
        .back-btn { border: none; background: none; padding: 0.5rem; color: #000; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .back-btn i { font-size: 1.2rem; margin-right: 2px; } 

        .v { flex-grow: 1; overflow-y: auto; background-color: #fff; }
        .f-card { background-color: #fff; border-radius: 16px; box-shadow: none; }
        .f-grp { margin-bottom: 1.5rem; }
        .f-lbl { display: block; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; color: #333; }
        .f-inp, .f-txt, .f-sel { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--c-bord); border-radius: 12px; font-size: 1rem; outline: none; transition: border-color 0.2s; background-color: #fff; }
        .f-inp:focus, .f-txt:focus { border-color: var(--c-acc); }
        .f-txt { resize: vertical; min-height: 100px; }

        .t-opt { border: 2px solid var(--c-bord); border-radius: 12px; padding: 1rem; transition: all 0.2s; background-color: #fcfcfc; }
        .t-opt.active { border-color: var(--c-acc); background-color: var(--c-lite); }
        .t-opt-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.2rem; }
        .t-opt-desc { font-size: 0.85rem; color: #555; margin: 0; line-height: 1.3; }
        .t-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .s-btn { width: 100%; padding: 1rem; background-color: var(--c-acc); color: #fff; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; position: relative; overflow: hidden; }
        .s-spin { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .g-inp-c { display: flex; gap: 10px; }
        .g-add-btn { width: 44px; height: 44px; padding: 0; border: none; background-color: var(--c-acc); color: #fff; border-radius: 12px; font-size: 1.5rem; line-height: 1; flex-shrink: 0; }
        .g-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background-color: #f7f7f7; border: 1px solid var(--c-bord); border-radius: 12px; font-size: 0.95rem; }
        .g-item .g-del-btn { margin-left: 10px; background: none; border: none; color: var(--c-dan); font-size: 1.2rem; padding: 0; line-height: 1; }

        #tagCont { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .t-chip { display: inline-flex; align-items: center; background-color: var(--c-lite); color: var(--c-acc); padding: 4px 10px; border-radius: 16px; font-size: 0.85rem; font-weight: 600; }
        .t-chip .r-tag { margin-left: 8px; opacity: 0.7; font-size: 0.9rem; }

        .sum-box { padding: 1rem; border: 1px solid var(--c-bord); border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background-color: #fff; transition: background-color 0.2s; }
        .sum-box span { font-weight: 600; color: var(--c-acc); }

        /* Bottom Sheet & Modal */
        .bs { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0, 0, 0, 0.4); justify-content: center; align-items: flex-end; }
        .bs-cont { background-color: #fff; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 10px 20px 0 20px; transform: translateY(100%); transition: transform 0.3s ease-out; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; max-height: 90vh; }
        .bs.show .bs-cont { transform: translateY(0); }
        .h-bar { width: 40px; height: 4px; background-color: #ddd; border-radius: 2px; margin: 0 auto 10px; }
        .bs-head { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid var(--c-bord); }
        .bs-title { font-size: 1.2rem; font-weight: 700; margin: 0; }
        .bs-close { background: none; border: none; color: #888; font-size: 1.5rem; padding: 5px; }
        .bs-area { flex-grow: 1; overflow-y: auto; padding-bottom: 20px; }
        .bs-foot { padding: 10px 20px 20px 20px; background-color: #fff; border-top: 1px solid var(--c-bord); position: sticky; bottom: 0; width: 100%; display: flex; justify-content: center; }

        /* Calendar */
        .cal-head { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; }
        .cal-nav { background: none; border: none; color: var(--c-acc); font-size: 1.5rem; padding: 5px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-wday { font-size: 0.9rem; font-weight: 600; color: #555; padding: 8px 0; }
        .cal-wday:first-child { color: var(--c-dan); } 
        .cal-wday:last-child { color: var(--c-acc); }
        .cal-day { width: 36px; height: 36px; line-height: 36px; margin: 0 auto; border-radius: 50%; display: block; text-align: center; }
        .cal-day.in { color: #bbb; cursor: default; }
        .cal-day.td { font-weight: 700; border: 2px solid var(--c-acc); color: var(--c-acc); background-color: var(--c-lite); }
        .cal-day.sel { background-color: var(--c-acc); color: #fff !important; font-weight: 700; border: none; }
        .cal-day:not(.in):not(.sel):hover { background-color: #eee; }
        .dur-grp { display: flex; align-items: center; gap: 10px; }
        .dur-grp span { font-weight: 600; }
        .exc-opt { display: flex; gap: 20px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--c-bord); }
        .end-disp { text-align: center; padding: 1rem; background-color: #f7f7f7; border-radius: 12px; margin: 20px 0; }
        .end-disp span { font-weight: 700; color: var(--c-dan); }

        /* Category */
        .cat-grp { margin-bottom: 20px; }
        .cat-grp-title { font-size: 1.1rem; font-weight: 700; color: #333; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--c-lite); }
        .cat-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .cat-chip { padding: 8px 15px; border-radius: 20px; border: 1px solid var(--c-bord); background-color: #fcfcfc; font-size: 0.95rem; font-weight: 500; }
        .cat-chip.selected { background-color: var(--c-acc); color: #fff; border-color: var(--c-acc); font-weight: 600; }
        .cat-sel-list { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; margin-bottom: 10px; background-color: #f7f7f7; border-radius: 12px; }
        .cat-sel-item { padding: 4px 10px; background-color: var(--c-lite); color: var(--c-acc); border-radius: 16px; font-size: 0.85rem; font-weight: 600; }
        .no-results { text-align: center; color: #888; padding: 20px 0; }

        /* Message Modal */
        #modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 16px; max-width: 90%; min-width: 300px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transform: scale(0.9); opacity: 0; transition: transform 0.2s, opacity 0.2s; }
        .modal-title { margin-top: 0; font-size: 1.2rem; font-weight: 700; color: var(--c-acc); margin-bottom: 10px; }
        .modal-text { margin-bottom: 0; font-size: 1rem; color: #555; line-height: 1.4; }
    </style>
</head>
<body>

<div id="app-container">
    
    <header class="h-main">
        <button class="back-btn i" onclick="window.history.back()">
            <i class="material-icons">arrow_back_ios</i>
        </button>
        <h1 class="h-main-title">챌린지 만들기</h1>
    </header>

    <div id="create-challenge-view" class="v">
        <form id="challenge-form" class="f-card" onsubmit="event.preventDefault(); hdlCrt();">
            
            <div class="f-grp">
                <label for="title" class="f-lbl">챌린지 제목</label>
                <input type="text" id="title" class="f-inp" placeholder="매일 아침 6시에 일어나기" required maxlength="50">
            </div>
            
            <div class="f-grp">
                <label class="f-lbl">챌린지 타입</label>
                <div class="t-toggle" id="type-toggle">
                    <div class="t-opt active i" data-public="false">
                        <span class="t-opt-title">개인 챌린지</span>
                        <p class="t-opt-desc">나만의 목표를 달성해 보세요!</p>
                    </div>
                    <div class="t-opt i" data-public="true">
                        <span class="t-opt-title">팀 챌린지</span>
                        <p class="t-opt-desc">사람들과 함께 목표를 달성해 보세요!</p>
                    </div>
                </div>
                <input type="hidden" id="isPublic" value="false" required>
            </div>

            <div class="f-grp">
                <label class="f-lbl" id="goal-lbl">목표</label>
                <div class="g-inp-c">
                    <input type="text" id="goalInp" class="f-inp" placeholder="새로운 목표를 입력하세요 (예: 매일 1시간 독서)" maxlength="100">
                    <button type="button" id="addGoalBtn" class="g-add-btn i">+</button>
                </div>
                <div id="goalListCont"></div>
                <input type="hidden" id="goalsHidden" required> 
            </div>
            
            <div class="f-grp h" id="max-p-grp">
                <label for="maxP" class="f-lbl">최대 참가 인원</label>
                <input type="number" id="maxP" class="f-inp" value="10" min="2" max="100" placeholder="2명 이상 100명 이하 (기본값: 10)">
            </div>
            
            <div class="f-grp" id="reward-grp">
                <label for="reward" class="f-lbl">나만의 보상 (선택 사항)</label>
                <input type="text" id="reward" class="f-inp" placeholder="챌린지 성공 시 나에게 주는 보상 (예: 제주도 여행)" maxlength="100">
            </div>
            
            <div class="f-grp">
                <label for="tags" class="f-lbl">태그 (선택 사항) - 입력 후 Enter</label>
                <div id="tagCont"></div>
                <input type="text" id="tags" class="f-inp" placeholder="예: #독서, 운동, 재테크 (최대 5개)">
                <small class="block mt-1 text-xs text-gray-500">쉼표, 공백, Enter 키로 태그를 추가할 수 있습니다.</small>
            </div>
            
            <div class="f-grp">
                <label class="f-lbl">카테고리</label>
                <div class="sum-box i" onclick="showCatMdl()">
                    <span id="catSumTxt">카테고리를 선택해 주세요 (최대 3개)</span>
                    <i class="material-icons">chevron_right</i>
                </div>
                <input type="hidden" id="catsHidden" value="[]" required>
            </div>

            <div class="f-grp">
                <label class="f-lbl">기간 설정</label>
                <div class="sum-box i" onclick="showDateMdl()">
                    <span id="dateSumTxt">기간을 설정해 주세요</span>
                    <i class="material-icons">chevron_right</i>
                </div>
                <input type="hidden" id="startDH" required>
                <input type="hidden" id="durationDH" required>
                <input type="hidden" id="endDH" required>
                <input type="hidden" id="excludeWH" value="false">
            </div>
            
            <button type="submit" id="submit-button" class="s-btn i">
                챌린지 시작하기
            </button>
        </form>
    </div>
    
</div>

<!-- Category Modal -->
<div id="catMdl" class="bs">
    <div class="bs-cont">
        <div class="h-bar"></div>
        <div class="bs-head">
            <h3 class="bs-title">카테고리 선택</h3>
            <button class="bs-close i" onclick="hideCatMdl()"><i class="material-icons">close</i></button>
        </div>
        <div class="bs-area">
            <div class="f-grp">
                <input type="text" id="catSearchInp" class="f-inp" placeholder="카테고리 검색 (예: 코딩, 다이어트, 주식)" style="margin-bottom: 15px;">
            </div>
            <p style="font-size: 0.9rem; color: #555; margin-top: 0; margin-bottom: 15px;">챌린지를 대표할 카테고리를 최대 3개까지 선택해 주세요.</p>
            <div class="cat-grp">
                <h4 class="cat-grp-title">선택된 카테고리: <span id="catCountDisp">0</span>/3</h4>
                <div id="selCatList" class="cat-sel-list">
                    <p id="noCatSel" style="font-size: 0.85rem; color: #888; margin: 0;">선택된 카테고리가 없습니다.</p>
                </div>
            </div>
            <div id="catsListCont"></div>
        </div>
        <div class="bs-foot">
            <button class="s-btn i" id="confCatBtn" onclick="confCatSel()">카테고리 선택 완료</button>
        </div>
    </div>
</div>

<!-- Date Modal -->
<div id="dateMdl" class="bs">
    <div class="bs-cont">
        <div class="h-bar"></div>
        <div class="bs-head">
            <h3 class="bs-title">챌린지 기간 설정</h3>
             <button class="bs-close i" onclick="hideDateMdl()"><i class="material-icons">close</i></button>
        </div>
        <div class="bs-area">
            <div class="f-grp">
                <label class="f-lbl">시작일 선택</label>
                <div id="calCont">
                    <div class="cal-head">
                        <button id="prevMonth" class="cal-nav i"><i class="material-icons">chevron_left</i></button>
                        <span id="curMY" class="text-lg font-bold"></span>
                        <button id="nextMonth" class="cal-nav i"><i class="material-icons">chevron_right</i></button>
                    </div>
                    <div class="cal-grid" id="calGrid">
                        <div class="cal-wday">일</div><div class="cal-wday">월</div><div class="cal-wday">화</div><div class="cal-wday">수</div><div class="cal-wday">목</div><div class="cal-wday">금</div><div class="cal-wday">토</div>
                    </div>
                </div>
            </div>
            
            <div class="f-grp">
                <label class="f-lbl">기간 설정</label>
                <div class="dur-grp">
                    <input type="number" id="modalDurInp" class="f-inp" value="7" min="1" max="365" required style="width: 100px; text-align: right;">
                    <span>일 간</span>
                </div>
                <div class="exc-opt">
                    <label>
                        <input type="checkbox" id="excWkndChk">
                        주말(토/일) 제외
                    </label>
                </div>
            </div>
            
            <div class="end-disp">
                <p style="margin: 0; font-weight: 500; color: #333;">챌린지 종료일: <span id="modalEndDisp">시작일과 기간을 설정해 주세요</span></p>
                <p style="font-size: 0.8rem; margin-top: 5px; color:#555;">(실제 수행 일수: <span id="actualDurDisp" style="color:#000;">0</span>일)</p>
            </div>
        </div>

        <div class="bs-foot">
            <button class="s-btn i" id="confDateBtn" onclick="confDateSel()">기간 설정 완료</button>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div id="modal">
    <div class="modal-content">
        <h3 class="modal-title" id="modal-title"></h3>
        <p class="modal-text" id="modal-text"></p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase 설정
    const uConfig = { apiKey: "AIzaSyBMowSIHMdz69dYY-mAW8l6VjKxBW54SfU", authDomain: "doing-a.firebaseapp.com", projectId: "doing-a", storageBucket: "doing-a.firebasestorage.app", messagingSenderId: "24279439955", appId: "1:24279439955:web:2bf5c965de1b0a236884a6", measurementId: "G-VJ5YQRGNE3" };
    const fConfig = typeof __firebase_config !== 'undefined' && JSON.parse(__firebase_config).apiKey ? JSON.parse(__firebase_config) : uConfig;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const app = initializeApp(fConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // 글로벌 상태
    let uId = null;
    let dName = null; 
    let isAuth = false; 
    let gs = []; // Goals (목표)
    let ts = []; // Tags (태그)
    let cs = []; // Categories (카테고리)
    let selDate = new Date(); // Selected Start Date
    let calDate = new Date(); // Current Calendar Month
    let mdlCb = null; // Modal Callback

    // DOM 요소 (일부만 정의)
    const mdl = document.getElementById('modal');
    const sBtn = document.getElementById('submit-button');
    const rGrp = document.getElementById('reward-grp');
    const gLbl = document.getElementById('goal-lbl');
    const gInp = document.getElementById('goalInp');
    const gListCont = document.getElementById('goalListCont');
    const goalsH = document.getElementById('goalsHidden');
    const mPGrp = document.getElementById('max-p-grp');
    const mPInp = document.getElementById('maxP');
    const tInp = document.getElementById('tags');
    const tCont = document.getElementById('tagCont');
    const dateMdl = document.getElementById('dateMdl');
    const calGrid = document.getElementById('calGrid');
    const curMY = document.getElementById('curMY');
    const modalDurInp = document.getElementById('modalDurInp');
    const excWkndChk = document.getElementById('excWkndChk');
    const dateSumTxt = document.getElementById('dateSumTxt');
    const startDH = document.getElementById('startDH');
    const durationDH = document.getElementById('durationDH');
    const endDH = document.getElementById('endDH');
    const excludeWH = document.getElementById('excludeWH');
    const catMdl = document.getElementById('catMdl');
    const catSumTxt = document.getElementById('catSumTxt');
    const catsH = document.getElementById('catsHidden');
    const catsListCont = document.getElementById('catsListCont');
    const selCatList = document.getElementById('selCatList');
    const catCountDisp = document.getElementById('catCountDisp');
    const noCatSel = document.getElementById('noCatSel');
    const catSearchInp = document.getElementById('catSearchInp'); // 카테고리 검색 input

    // **정제된 카테고리 정의 (사용자 요청 반영: 스터디, 인터넷 강의 등 포괄적인 의미 강조)**
    const CATS = {
        '직무/기술 역량 강화': [
            '프론트엔드 개발 (웹)', '백엔드 개발 (서버)', 'AI/머신러닝 심화', '데이터 분석 마스터', '코딩 알고리즘 연습',
            'IT 자격증 취득', '전문직 자격증 준비', '실무 툴(엑셀/PPT) 마스터', '기획서/보고서 작성 훈련', '발표 스킬 강화'
        ],
        '외국어 및 심층 학습': [
            '영어 회화 (매일)', 'TOEIC/TOEFL 집중', '제2외국어 (일본어)', '제2외국어 (중국어)', '학술 논문 분석/작성',
            '원서 읽기 도전', '인터넷 강의 완강 (인강)', '지식 공유 강의 제작'
        ],
        '시험 및 스터디 그룹': [
            '자격증 시험 스터디', '공무원 시험 준비', '대학원 입시 준비', '모의 투자 스터디', '책 리뷰/토론 스터디',
            '외국어 시험 합격 스터디', '공모전 팀 프로젝트', '사이드 프로젝트 개발', '팀 목표 달성 챌린지'
        ],
        '독서 및 인문 지식': [
            '인문학 고전 독파', '소설/문학 정독', '경제/경영 서적 이해', '과학/기술 지식 학습', '매일 30분 독서 습관',
            '역사/철학 공부', '시사/뉴스 스크랩', '교양서적 읽기', '서평 쓰기 루틴'
        ],
        '재테크 및 금융': [
            '가계부 매일 작성', '지출 예산 통제', '부동산 지식 스터디', '주식 기본 분석/실전', '경제 뉴스 큐레이션',
            '재무 설계 및 목표 설정', '소액 투자 습관', '비상금 모으기'
        ],
        '건강 및 운동': [
            '헬스장 주 4회 출석', '맨몸 근력 운동', '매일 1시간 러닝', '자전거 라이딩 (장거리)', '요가/필라테스 루틴',
            '스트레칭 및 유연성', '마라톤/대회 준비', '스포츠 기술 향상', '걷기/만보 달성'
        ],
        '식단 및 영양': [
            '하루 2L 물 마시기', '클린 식단 유지', '다이어트 식단 기록', '저염식/건강식 요리', '영양제 꾸준히 섭취',
            '밀가루/설탕 줄이기', '과식/야식 금지', '식단 분석 및 개선'
        ],
        '정신 건강 및 휴식': [
            '매일 10분 명상', '취침 전 디지털 디톡스', '충분한 수면 시간 확보', '스트레스 해소법 실천', '혼자만의 시간 갖기'
        ],
        '생활 습관 개선': [
            '미라클 모닝 (새벽 기상)', '주간 대청소 (환경 정리)', '미니멀 라이프 실천', '규칙적인 식사 시간', '반려동물 건강 관리'
        ],
        '창작 및 취미 심화': [
            '악기 (기타/피아노) 연습', '노래/보컬 트레이닝', '영상 편집 (유튜브)', '포토샵/일러스트 연습', '드로잉/그림 그리기',
            '사진 촬영 및 보정', 'DIY 수공예품 제작', '글쓰기 (소설/시)', '블로그/SNS 꾸준히 업로드'
        ],
        '기타 및 자유 주제': ['자유 주제 챌린지', '기타 개인 목표', '새로운 목표 시도']
    };
    // --- UI/UX & 유틸리티 ---

    window.showModal = function(title, text, cb = null) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-text').textContent = text;
        mdlCb = cb;
        mdl.style.display = 'flex';
        setTimeout(() => {
            mdl.querySelector('.modal-content').style.transform = 'scale(1)';
            mdl.querySelector('.modal-content').style.opacity = '1';
        }, 10); 
    }
    window.hideModal = function() {
        mdl.querySelector('.modal-content').style.transform = 'scale(0.9)';
        mdl.querySelector('.modal-content').style.opacity = '0';
        setTimeout(() => { mdl.style.display = 'none'; }, 200); 
    }

    window.showDateMdl = function() {
        calDate = new Date(selDate); 
        renderCal(calDate.getFullYear(), calDate.getMonth());
        updMdlDateUI();
        dateMdl.style.display = 'flex';
        setTimeout(() => { dateMdl.classList.add('show'); }, 10);
    }
    window.hideDateMdl = function() {
        dateMdl.classList.remove('show');
        setTimeout(() => { dateMdl.style.display = 'none'; }, 300);
    }
    
    window.showCatMdl = function() {
        catSearchInp.value = ''; // 검색창 초기화
        renderCatsList();
        renderSelCatSum();
        catMdl.style.display = 'flex';
        setTimeout(() => { catMdl.classList.add('show'); }, 10);
    }
    window.hideCatMdl = function() {
        catMdl.classList.remove('show');
        setTimeout(() => { catMdl.style.display = 'none'; }, 300);
    }

    function fmtIso(d) {
        if (!d) return '';
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function fmtDisp(d) {
        if (typeof d === 'string') d = new Date(d.replace(/-/g, '/'));
        if (!(d instanceof Date) || isNaN(d)) return '';
        return `${d.getFullYear()}년 ${String(d.getMonth() + 1).padStart(2, '0')}월 ${String(d.getDate()).padStart(2, '0')}일`;
    }

    function calcPeriod(sDate, dur, excWknd) {
        if (!(sDate instanceof Date) || isNaN(dur) || dur < 1) return { eDate: null, aDur: 0 };
        let aDur = 0, dPass = 0, eDate = null;
        while (aDur < dur) {
            let cDate = new Date(sDate);
            cDate.setDate(sDate.getDate() + dPass);
            const dOW = cDate.getDay();
            const isWknd = dOW === 0 || dOW === 6;

            if (!excWknd || !isWknd) aDur++;
            
            if (aDur === dur) {
                eDate = cDate;
                break;
            }
            dPass++;
            if (dPass > 365 * 2) break; // Safety
        }
        return { eDate: eDate, aDur: dur };
    }

    function updMdlDateUI() {
        const dur = parseInt(modalDurInp.value, 10);
        const excWknd = excWkndChk.checked;
        const today = new Date();
        const start = selDate; 
        
        if (start < today && start.toDateString() !== today.toDateString()) {
             selDate = today;
             renderCal(calDate.getFullYear(), calDate.getMonth());
             return updMdlDateUI(); 
        }

        if (dur && dur >= 1) {
            const { eDate, aDur } = calcPeriod(start, dur, excWknd);
            
            if (eDate) {
                document.getElementById('modalEndDisp').textContent = fmtDisp(eDate);
                document.getElementById('actualDurDisp').textContent = aDur;
                startDH.value = fmtIso(start);
                endDH.value = fmtIso(eDate);
                durationDH.value = dur;
                excludeWH.value = excWknd;
            } else {
                document.getElementById('modalEndDisp').textContent = '기간 계산 오류'; document.getElementById('actualDurDisp').textContent = 0;
            }
        } else {
            document.getElementById('modalEndDisp').textContent = '시작일과 유효한 기간을 설정해 주세요'; document.getElementById('actualDurDisp').textContent = 0;
            startDH.value = endDH.value = durationDH.value = ''; excludeWH.value = false;
        }
    }
    
    function renderCal(y, m) {
        const first = new Date(y, m, 1), last = new Date(y, m + 1, 0), today = new Date();
        const startD = first.getDay(); 
        curMY.textContent = `${y}년 ${m + 1}월`;
        
        let removeCount = calGrid.children.length - 7;
        while(removeCount-- > 0) calGrid.removeChild(calGrid.lastChild);

        let html = '';
        for (let i = 0; i < startD; i++) html += '<div class="cal-day in"></div>';

        for (let day = 1; day <= last.getDate(); day++) {
            const date = new Date(y, m, day);
            const isPast = date < today && date.toDateString() !== today.toDateString();
            const isToday = date.toDateString() === today.toDateString();
            const isSel = date.toDateString() === selDate.toDateString();
            const classes = ['cal-day', isPast ? 'in' : 'i', isToday ? 'td' : '', isSel ? 'sel' : ''].join(' ');
            
            html += `<div class="${classes}" data-date="${y}-${m + 1}-${day}">${day}</div>`;
        }
        calGrid.insertAdjacentHTML('beforeend', html);
        
        calGrid.querySelectorAll('.cal-day.i').forEach(el => {
            el.addEventListener('click', (e) => {
                const parts = e.target.getAttribute('data-date').split('-');
                selDate = new Date(parts[0], parts[1] - 1, parts[2]);
                renderCal(y, m);
                updMdlDateUI();
            });
        });
    }

    window.confDateSel = function() {
        const sD = startDH.value, dur = durationDH.value, eD = endDH.value, excW = excludeWH.value === 'true';
        if (!sD || !eD || isNaN(dur) || dur < 1) return showModal('기간 설정 오류', '시작일과 유효한 기간(1~365일)을 설정해 주세요.');
        
        const dStart = fmtDisp(sD), dEnd = fmtDisp(eD);
        let excTxt = excW ? ' (주말 제외)' : '';
        dateSumTxt.innerHTML = `${dStart}부터 ${dur}일 간 ${excTxt} (<span style="color: var(--c-dan);">${dEnd} 종료</span>)`;
        hideDateMdl();
    }
    
    // --- Category Logic ---
    function renderCatsList(searchTerm = '') {
        catsListCont.innerHTML = '';
        const term = searchTerm.toLowerCase().trim();
        let html = '';
        let matchCount = 0;

        for (const mainCat in CATS) {
            const filteredSubCats = CATS[mainCat].filter(subCat => 
                subCat.toLowerCase().includes(term) || mainCat.toLowerCase().includes(term)
            );

            if (filteredSubCats.length > 0) {
                html += `<div class="cat-grp"><h4 class="cat-grp-title">${mainCat}</h4><div class="cat-chips">`;
                filteredSubCats.forEach(subCat => {
                    const sel = cs.includes(subCat) ? 'selected' : '';
                    html += `<div class="cat-chip i ${sel}" data-cat="${subCat}">${subCat}</div>`;
                    matchCount++;
                });
                html += `</div></div>`;
            }
        }
        
        if (matchCount === 0 && term.length > 0) {
            catsListCont.innerHTML = `<p class="no-results">검색어 "${term}"와 일치하는 카테고리가 없습니다.</p>`;
        } else {
            catsListCont.innerHTML = html;
            catsListCont.querySelectorAll('.cat-chip').forEach(el => el.addEventListener('click', (e) => toggleCatSel(e.target.getAttribute('data-cat'))));
        }
    }

    function toggleCatSel(cat) {
        const idx = cs.indexOf(cat);
        if (idx === -1) {
            if (cs.length < 3) cs.push(cat);
        } else {
            cs.splice(idx, 1);
        }
        renderCatsList(catSearchInp.value); // 검색어 유지하며 목록 업데이트
        renderSelCatSum(); 
    }
    
    function renderSelCatSum() {
        selCatList.innerHTML = '';
        catCountDisp.textContent = cs.length;

        if (cs.length === 0) {
            noCatSel.style.display = 'block';
            selCatList.appendChild(noCatSel);
        } else {
            noCatSel.style.display = 'none';
            cs.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'cat-sel-item i';
                item.textContent = cat;
                item.addEventListener('click', () => toggleCatSel(cat));
                selCatList.appendChild(item);
            });
        }
    }
    
    window.confCatSel = function() {
        if (cs.length === 0) return showModal('카테고리 선택 필요', '최소 1개 이상의 카테고리를 선택해 주세요.');
        catSumTxt.textContent = `${cs.join(', ')} (${cs.length}개 선택)`;
        catsH.value = JSON.stringify(cs);
        hideCatMdl();
    }
    
    // --- Goal/Tag Logic ---
    function renderGoals() {
        gListCont.innerHTML = gs.length === 0 
            ? '<p style="color:#888; font-size: 0.9rem; margin-top: 10px;">+ 버튼을 눌러 목표를 추가하세요.</p>'
            : gs.map((txt, i) => `<div class="g-item"><span>${txt}</span><button type="button" class="g-del-btn i" data-idx="${i}"><i class="material-icons" style="font-size: 1.1rem;">close</i></button></div>`).join('');
        
        goalsH.value = JSON.stringify(gs); 

        gListCont.querySelectorAll('.g-del-btn').forEach(btn => btn.addEventListener('click', (e) => {
            gs.splice(parseInt(e.currentTarget.getAttribute('data-idx'), 10), 1);
            renderGoals();
        }));
    }

    function addGoal() {
        const txt = gInp.value.trim();
        if (txt && !gs.includes(txt)) {
            gs.push(txt);
            gInp.value = '';
            renderGoals();
        } else if (gs.includes(txt)) {
            gInp.value = '';
        }
    }
    
    function addTags(val) {
        const raw = val || tInp.value.trim();
        if (!raw) return;

        const newTags = raw.split(/[,\s#]+/).map(t => t.trim()).filter(t => t.length > 0).slice(0, 5 - ts.length);
        newTags.forEach(t => {
            if (ts.length < 5 && !ts.includes(t)) ts.push(t);
        });

        tInp.value = '';
        renderTags();
    }

    function renderTags() {
        ts = ts.slice(0, 5);
        tCont.innerHTML = ts.map(t => 
            `<div class="t-chip i">#${t}<span class="r-tag material-icons i" data-tag="${t}" style="font-size: 0.9rem;">close</span></div>`
        ).join('');

        tCont.querySelectorAll('.r-tag').forEach(btn => btn.addEventListener('click', (e) => {
            ts = ts.filter(t => t !== e.currentTarget.getAttribute('data-tag'));
            renderTags();
        }));
        
        tInp.disabled = ts.length >= 5;
        tInp.placeholder = ts.length >= 5 ? '최대 5개 태그만 가능합니다.' : '예: #독서, 운동, 재테크 (최대 5개)';
    }

    // --- Dynamic UI ---
    function setupTypeToggle() {
        document.querySelectorAll('.t-opt').forEach(opt => opt.addEventListener('click', (e) => {
            const isP = e.currentTarget.getAttribute('data-public') === 'true';
            document.querySelectorAll('.t-opt').forEach(o => o.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.getElementById('isPublic').value = isP;
            updDynFields(isP);
        }));
        updDynFields(document.getElementById('isPublic').value === 'true');
    }

    function updDynFields(isP) {
        rGrp.classList.toggle('h', isP);
        mPGrp.classList.toggle('h', !isP);
        isP ? mPInp.setAttribute('required', 'required') : mPInp.removeAttribute('required');
        gLbl.textContent = isP ? `챌린지 소개 및 상세 목표` : `목표`;
    }

    // --- Submission ---
    window.hdlCrt = async function() {
        // UID와 DisplayName이 모두 있어야 합니다.
        if (!uId || !dName) return showModal('인증 오류', '사용자 정보(UID/디스플레이 이름)가 없습니다.');

        const title = document.getElementById('title').value.trim();
        const reward = document.getElementById('reward').value.trim();
        const isP = document.getElementById('isPublic').value === 'true'; 
        const sD = startDH.value, eD = endDH.value, dur = parseInt(durationDH.value, 10);
        const excW = excludeWH.value === 'true';
        
        // 실제 DisplayName 사용
        const creatorName = dName; 
        let maxP = isP ? parseInt(mPInp.value, 10) : 0; 
        
        if (gs.length === 0) return showModal('필수 정보 누락', '최소 1개 이상의 목표를 추가해 주세요.');
        if (cs.length === 0) return showModal('필수 정보 누락', '최소 1개 이상의 카테고리를 선택해 주세요.');
        if (!title || !sD || !eD || isNaN(dur)) return showModal('필수 정보 누락', '제목 및 기간 설정은 필수 입력 사항입니다.');
        if (isP && (isNaN(maxP) || maxP < 2 || maxP > 100)) return showModal('최대 인원 오류', '팀 챌린지는 최소 2명 이상, 100명 이하로 설정해야 합니다.');

        sBtn.disabled = true;
        sBtn.innerHTML = `<span class="s-spin"></span> 챌린지 생성 중...`;
        
        try {
            const cPath = isP ? `/artifacts/${appId}/public/data/challenges` : `/artifacts/${appId}/users/${uId}/challenges`;

            let data = {
                title: title,
                goalsList: gs,
                description: "",
                creatorId: uId, creatorName: creatorName, 
                createdAt: Date.now(), updatedAt: Date.now(), 
                startDate: sD, endDate: eD, durationDays: dur, excludeWeekends: excW, 
                isPublic: isP, status: 'active',
                participants: 1, participantIds: [uId], 
                tags: ts, categories: cs,
            };

            if (isP) data = { ...data, maxParticipants: maxP };
            
            if (!isP) {
                const { aDur } = calcPeriod(new Date(sD.replace(/-/g, '/')), dur, excW);
                data = { ...data, actualDurationDays: aDur, currentCertCount: 0, lastCertifiedDate: "", reward: reward || null };
            }
            
            const dRef = await addDoc(collection(db, cPath), data);

            window.location.href = `/challenge/view.html?uid=${dRef.id}`;

        } catch (err) {
            console.error("Error creating challenge: ", err);
            showModal('생성 실패', '챌린지 생성 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.', () => {
                sBtn.disabled = false;
                sBtn.innerHTML = '챌린지 시작하기';
            });
        }
    }

    // --- Auth ---
    onAuthStateChanged(auth, async (user) => {
        if (!isAuth) {
            const tkn = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            isAuth = true; 
            if (!user && tkn) {
                try { await signInWithCustomToken(auth, tkn); return; } catch (e) { console.error("Login failed.", e); return; }
            } else if (!user) {
                // Not authenticated, but allowing anonymous sign-in for canvas setup 
                return;
            }
        }
        if (user) {
            uId = user.uid;
            // 사용자 객체에서 displayName을 가져옴
            dName = user.displayName || `User_${user.uid.substring(0, 8)}`; 
            document.fonts.ready.then(() => document.getElementById('app-container').classList.add('font-loaded'));
        }
    });

    // --- Init ---
    window.addEventListener('load', () => {
        const appCont = document.getElementById('app-container');
        appCont.style.minHeight = `${window.innerHeight}px`;
        window.addEventListener('resize', () => appCont.style.minHeight = `${window.innerHeight}px`);
        
        mdl.addEventListener('click', (e) => {
            if (e.target === mdl) { if (mdlCb) { mdlCb(); mdlCb = null; } hideModal(); }
        });
        dateMdl.addEventListener('click', (e) => { if (e.target === dateMdl) hideDateMdl(); });
        catMdl.addEventListener('click', (e) => { if (e.target === catMdl) hideCatMdl(); });
        
        // 카테고리 검색 기능 리스너 추가
        catSearchInp.addEventListener('input', (e) => renderCatsList(e.target.value));

        setupTypeToggle();
        
        document.getElementById('prevMonth').addEventListener('click', () => {
            calDate.setMonth(calDate.getMonth() - 1);
            const today = new Date();
            if (calDate < new Date(today.getFullYear(), today.getMonth(), 1)) calDate.setMonth(calDate.getMonth() + 1);
            renderCal(calDate.getFullYear(), calDate.getMonth());
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            calDate.setMonth(calDate.getMonth() + 1);
            renderCal(calDate.getFullYear(), calDate.getMonth());
        });
        modalDurInp.addEventListener('input', updMdlDateUI);
        excWkndChk.addEventListener('change', updMdlDateUI);

        document.getElementById('addGoalBtn').addEventListener('click', addGoal);
        gInp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addGoal(); } });
        
        tInp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTags(tInp.value); } });
        tInp.addEventListener('input', (e) => { if (e.target.value.includes(',') || e.target.value.includes(' ')) addTags(e.target.value); });
        
        const today = new Date();
        selDate = today; calDate = new Date(today.getFullYear(), today.getMonth(), 1); 

        renderGoals(); renderTags();
        dateSumTxt.textContent = "기간을 설정해 주세요 (클릭)";
        renderCal(today.getFullYear(), today.getMonth());
        updMdlDateUI();
        
        catSumTxt.textContent = `카테고리를 선택해 주세요 (최대 3개)`; 
        catsH.value = JSON.stringify(cs); 
    });
</script>
</body>
</html>
