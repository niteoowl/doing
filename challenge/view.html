<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ë„ì „ ìƒì„¸ ë³´ê¸°</title>
    <!-- Pretendard í°íŠ¸ CDN ì ìš© -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
    <!-- Google Material Icons (í•„ìˆ˜ì ì¸ ë‚´ë¹„ê²Œì´ì…˜ ë° UI ìš”ì†Œì—ë§Œ ì‚¬ìš©) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° iOS ì•ˆì „ ì˜ì—­ ì§€ì› */
        :root {
            --color-white: #ffffff;
            --color-black: #000000;
            --color-accent: #1E90FF; /* í¬ì¸íŠ¸ ë¸”ë£¨ (Dodger Blue) */
            --color-app-bg: #ffffff; 
            --color-content-bg: #ffffff; 
            --color-border: #e8e8e8; 
            --bottom-nav-height-mobile: 80px;
            --bottom-nav-height-pc: 60px; 
            --pc-max-width: 1200px; 
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard Variable', Pretendard, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-app-bg); 
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: var(--color-black);
            -webkit-tap-highlight-color: transparent;
            overflow-y: scroll; 
        }

        #app-container {
            width: 100%;
            background-color: var(--color-app-bg); 
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 100vh;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        #app-container.font-loaded { opacity: 1; }

        /* ------------------ PC/Desktop Layout ------------------ */
        @media (min-width: 640px) {
            body { align-items: flex-start; justify-content: center; }
            #app-container { max-width: var(--pc-max-width); box-shadow: none; }
            .view { padding: 2rem 3rem; padding-bottom: calc(2rem + var(--bottom-nav-height-pc)); }
            .bottom-nav { height: var(--bottom-nav-height-pc); }
            .nav-item i.material-icons { font-size: 20px; margin-bottom: 0; }
            .nav-item { flex-direction: row; gap: 8px; font-size: 0.9rem; }
            .header { padding: 0.5rem 3rem; }
            .tab-list { padding: 0 3rem; }
        }
        
        /* ------------------ Mobile Layout ------------------ */
        @media (max-width: 639px) {
            .bottom-nav { height: var(--bottom-nav-height-mobile); } 
            .header { padding: 0.5rem 1.5rem; } 
            .view { padding: 1.5rem 1.5rem; padding-bottom: calc(1.5rem + var(--bottom-nav-height-mobile)); }
            .nav-item i.material-icons { font-size: 28px; margin-bottom: 2px; }
            .nav-item { flex-direction: column; font-size: 0.75rem; line-height: 1.2; }
        }

        /* ê³µí†µ í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-content-bg);
            border-bottom: 1px solid var(--color-border); 
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-title {
            font-size: 1.4rem; 
            font-weight: 700; 
            color: var(--color-accent); 
            letter-spacing: -0.5px;
        }
        
        .header-action-button {
            background: none;
            border: none;
            color: var(--color-accent);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .header-action-button:hover { background-color: rgba(30, 144, 255, 0.05); }

        /* ë©”ì¸ ë·° ì»¨í…Œì´ë„ˆ */
        .view {
            flex-grow: 1;
            overflow-y: auto;
            display: block; 
            background-color: var(--color-app-bg); 
            padding-top: 1rem;
        }

        /* í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ ë°” (ê³µí†µ) */
        .bottom-nav {
            width: 100%;
            background-color: var(--color-content-bg);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 20;
            position: fixed;
            bottom: 0;
            padding-bottom: env(safe-area-inset-bottom); 
            border-top: 1px solid var(--color-border); 
            box-shadow: 0 -1px 8px rgba(0, 0, 0, 0.03); 
            left: 50%;
            transform: translateX(-50%);
            max-width: var(--pc-max-width);
        }
        
        .nav-item { color: #999; text-decoration: none; display: flex; align-items: center; justify-content: center; padding: 0.5rem; border-radius: 12px; transition: color 0.2s ease; }
        .nav-item.active { color: var(--color-accent); font-weight: 600; }

        /* ------------------ ì±Œë¦°ì§€ ìƒì„¸ ìŠ¤íƒ€ì¼ ------------------ */

        /* ì±Œë¦°ì§€ ì œëª© ë° ê¸°ë³¸ ì •ë³´ */
        .challenge-info {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 1.5rem;
        }
        .challenge-info h2 {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0 0 0.5rem 0;
        }
        .challenge-meta {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }
        .challenge-description {
            font-size: 1rem;
            line-height: 1.5;
            color: #333;
        }

        /* íƒ­ ë‚´ë¹„ê²Œì´ì…˜ */
        .tab-list {
            display: flex;
            gap: 1.5rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1.5rem;
            position: sticky;
            top: 60px; /* í—¤ë” ì•„ë˜ */
            background-color: var(--color-app-bg);
            z-index: 5;
            /* ëª¨ë°”ì¼ íŒ¨ë”© ì¡°ì • */
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            margin-left: -1.5rem;
            margin-right: -1.5rem;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }
        .tab-button.active {
            color: var(--color-accent);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--color-accent);
            border-radius: 2px 2px 0 0;
        }

        /* íƒ­ ì½˜í…ì¸  */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ê¸°ë¡í•˜ê¸° ì„¹ì…˜ */
        #record-section {
            background-color: #f8f8f8;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        #record-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 1rem;
            resize: vertical;
            font-size: 1rem;
            font-family: 'Pretendard Variable', sans-serif;
        }
        #record-section button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--color-accent);
            color: var(--color-white);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #record-section button:hover { background-color: #0d79e6; }
        
        /* ì§„í–‰ ê¸°ë¡ ëª©ë¡ */
        .progress-log-item {
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 0;
        }
        .progress-log-item:last-child { border-bottom: none; }
        .log-date { font-size: 0.85rem; color: #aaa; margin-bottom: 0.25rem; }
        .log-content { font-size: 0.95rem; line-height: 1.5; color: #333; }
        
        /* ------------------ íŒ€ ë©”ì‹ ì € ìŠ¤íƒ€ì¼ ------------------ */
        
        #team-chat-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 250px); /* ë·°í¬íŠ¸ ë†’ì´ ê¸°ë°˜ ì„ì‹œ ì„¤ì • */
            min-height: 400px;
            max-width: 800px;
            margin: 0 auto;
            position: relative; /* ì±„íŒ… ì…ë ¥ì°½ ê³ ì •ì„ ìœ„í•´ */
            padding-bottom: 60px; /* ì…ë ¥ì°½ ë†’ì´ í™•ë³´ */
        }
        
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f7f9fc;
            border-radius: 12px;
            border: 1px solid #e1e8f2;
        }
        
        .message-box {
            display: flex;
            margin-bottom: 10px;
        }

        .message-box.mine {
            justify-content: flex-end;
        }
        
        .message-box.theirs {
            justify-content: flex-start;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 20px;
            line-height: 1.4;
            font-size: 0.95rem;
            position: relative;
        }

        .message-box.mine .message {
            background-color: var(--color-accent);
            color: var(--color-white);
            border-bottom-right-radius: 5px;
            margin-left: 20px;
        }

        .message-box.theirs .message {
            background-color: var(--color-white);
            color: var(--color-black);
            border: 1px solid #ddd;
            border-bottom-left-radius: 5px;
            margin-right: 20px;
        }
        
        .message-sender {
            font-size: 0.75rem;
            color: #777;
            margin-bottom: 3px;
            display: block;
        }

        .message-box.mine .message-sender {
            text-align: right;
            color: var(--color-accent);
        }
        .message-box.theirs .message-sender {
            text-align: left;
        }

        #chat-input-area {
            display: flex;
            padding: 10px;
            background-color: var(--color-white);
            border-top: 1px solid var(--color-border);
            border-radius: 0 0 12px 12px; 
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        #chat-input-area input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 1rem;
            font-family: 'Pretendard Variable', sans-serif;
        }
        
        #chat-input-area button {
            background-color: var(--color-accent);
            color: var(--color-white);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #chat-input-area button:hover {
            background-color: #0d79e6;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        #modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--color-content-bg); padding: 30px; padding-bottom: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); width: 90%; max-width: 400px; text-align: center; transform: scale(0.9); opacity: 0; transition: all 0.2s ease-out; }
        .modal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: var(--color-black); }
        .modal-text { font-size: 1rem; margin-bottom: 20px; line-height: 1.4; color: #333; }
        #modal-close-button { width: 100%; padding: 0.75rem; margin-top: 10px; background-color: var(--color-accent); color: var(--color-white); border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        #modal-close-button:hover { background-color: #0d79e6; }
    </style>
</head>
<body>

<div id="app-container">
    <!-- í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ ë°” -->
    <div class="bottom-nav">
        <a class="nav-item interactive" href="/">
            <i class="material-icons">home</i>
            <span>í™ˆ</span>
        </a>
        <a class='nav-item interactive active' href='/challenge'>
            <i class="material-icons">local_fire_department</i> 
            <span>ë„ì „</span>
        </a>
        <a class="nav-item interactive" href="/my">
            <i class="material-icons">person</i>
            <span>ë§ˆì´</span>
        </a>
    </div>

    <!-- í—¤ë” -->
    <header class="header">
        <button class="header-action-button interactive" onclick="history.back()">
            <i class="material-icons">arrow_back</i>
        </button>
        <h1 class="header-title">ë„ì „ ìƒì„¸</h1>
        <button id="manage-button" class="header-action-button interactive" onclick="showTab('management')" title="ì„¤ì •/ê´€ë¦¬">
            <i class="material-icons">settings</i>
        </button>
    </header>

    <!-- ------------------ ë·° ì»¨í…Œì´ë„ˆ ------------------ -->
    <div id="challenge-view" class="view active">
        
        <!-- ì±Œë¦°ì§€ ê¸°ë³¸ ì •ë³´ -->
        <div class="challenge-info">
            <p id="challenge-type" class="challenge-meta"></p>
            <h2 id="challenge-title">... ë¡œë”© ì¤‘ ...</h2>
            <p id="challenge-status" class="challenge-meta"></p>
            <p id="challenge-description" class="challenge-description">ì±Œë¦°ì§€ ìƒì„¸ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>

        <!-- íƒ­ ë‚´ë¹„ê²Œì´ì…˜ -->
        <div class="tab-list">
            <button class="tab-button interactive active" data-tab="progress" onclick="showTab('progress')">
                ì§„í–‰ ê¸°ë¡
            </button>
            <!-- íŒ€ ì±Œë¦°ì§€ì¼ ê²½ìš°ì—ë§Œ í‘œì‹œ -->
            <button id="chat-tab-button" class="tab-button interactive" data-tab="chat" onclick="showTab('chat')" style="display: none;">
                íŒ€ ë©”ì‹ ì €
            </button>
            <button class="tab-button interactive" data-tab="management" onclick="showTab('management')">
                ê´€ë¦¬ / ì„¤ì •
            </button>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  ì˜ì—­ -->
        <div id="content-area">
            
            <!-- 1. ì§„í–‰ ê¸°ë¡ íƒ­ -->
            <div id="progress-tab" class="tab-content active">
                
                <!-- ê¸°ë¡í•˜ê¸° ì„¹ì…˜ -->
                <div id="record-section">
                    <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem;">ì˜¤ëŠ˜ì˜ ê¸°ë¡ ë‚¨ê¸°ê¸°</h3>
                    <textarea id="progress-input" placeholder="ì˜¤ëŠ˜ì˜ ë„ì „ ë‚´ìš©, ì„±ê³¼, ëŠë‚Œ ë“±ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
                    <button class="interactive" onclick="recordProgress()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                </div>
                
                <!-- ì§„í–‰ ê¸°ë¡ ëª©ë¡ -->
                <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem;">ì „ì²´ ê¸°ë¡</h3>
                <div id="progress-log-list">
                    <p style="text-align: center; color: #aaa;">ì§„í–‰ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
            
            <!-- 2. íŒ€ ë©”ì‹ ì € íƒ­ -->
            <div id="chat-tab" class="tab-content">
                <div id="team-chat-content">
                    <div id="chat-messages">
                        <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                        <p style="text-align: center; color: #999;">íŒ€ ì±Œë¦°ì§€ ì±„íŒ… ì‹œì‘!</p>
                    </div>
                    
                    <div id="chat-input-area">
                        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="handleChatKeydown(event)">
                        <button class="interactive" onclick="sendMessage()">
                            <i class="material-icons">send</i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 3. ê´€ë¦¬/ì„¤ì • íƒ­ -->
            <div id="management-tab" class="tab-content">
                <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem;">ì±Œë¦°ì§€ ê´€ë¦¬</h3>

                <div style="padding: 1rem; border: 1px solid var(--color-border); border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="font-weight: 600; margin-bottom: 0.5rem;">íŒ€ì› ê´€ë¦¬ (íŒ€ ì±Œë¦°ì§€ ì „ìš©)</h4>
                    <p id="team-members">í˜„ì¬ íŒ€ì›: ë‚˜ (Owner), ë©¤ë²„ A, ë©¤ë²„ B</p>
                    <button class="interactive" style="width: 100%; padding: 0.5rem; background-color: #f0f0f0; border: none; border-radius: 6px; margin-top: 0.75rem;" onclick="showModal('íŒ€ì› ì´ˆëŒ€', 'íŒ€ì› ì´ˆëŒ€ëŠ” í˜„ì¬ ë°ëª¨ ê¸°ëŠ¥ì…ë‹ˆë‹¤.')">
                        íŒ€ì› ì´ˆëŒ€í•˜ê¸°
                    </button>
                </div>

                <div style="padding: 1rem; border: 1px solid var(--color-border); border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="font-weight: 600; margin-bottom: 0.5rem;">ì±Œë¦°ì§€ ëª©í‘œ ìˆ˜ì •</h4>
                    <input type="text" placeholder="ìƒˆë¡œìš´ ì±Œë¦°ì§€ ëª©í‘œ" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 0.5rem;"/>
                    <button class="interactive" style="width: 100%; padding: 0.5rem; background-color: #f0f0f0; border: none; border-radius: 6px;" onclick="showModal('ëª©í‘œ ìˆ˜ì •', 'ëª©í‘œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (ë°ëª¨)')">
                        ìˆ˜ì •í•˜ê¸°
                    </button>
                </div>

                <button class="interactive" style="width: 100%; padding: 0.75rem; background-color: #ff4d4d; color: var(--color-white); border: none; border-radius: 8px; margin-top: 2rem;" onclick="showModal('ì±Œë¦°ì§€ ì¢…ë£Œ', 'ì±Œë¦°ì§€ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë°ëª¨)')">
                    ì±Œë¦°ì§€ ì¢…ë£Œí•˜ê¸°
                </button>
            </div>
            
        </div>
        
    </div>
    
</div>

<!-- ëª¨ë‹¬ íŒì—… êµ¬ì¡° (ë©”ì‹œì§€ ë°•ìŠ¤ ìš©ë„) -->
<div id="modal">
    <div class="modal-content">
        <h3 class="modal-title" id="modal-title"></h3>
        <p class="modal-text" id="modal-text"></p>
        <button id="modal-close-button" class="interactive" onclick="hideModal()">í™•ì¸</button>
    </div>
</div>

<script type="module">
    // Firebase SDK Import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        signInWithCustomToken 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        query, 
        onSnapshot,
        addDoc,
        serverTimestamp,
        orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase ì„¤ì • ë° ì´ˆê¸°í™” ---
    // Note: Firebase configuration is hardcoded for demonstration but should be replaced by __firebase_config in a live environment.
    const userFirebaseConfig = { 
        apiKey: "AIzaSyBMowSIHMdz69dYY-mAW8l6VjKxBW54SfU",
        authDomain: "doing-a.firebaseapp.com",
        projectId: "doing-a",
        storageBucket: "doing-a.firebasestorage.app",
        messagingSenderId: "24279439955",
        appId: "1:24279439955:web:2bf5c965de1b0a236884a6",
        measurementId: "G-VJ5YQRGNE3"
    };
    
    const firebaseConfig = typeof __firebase_config !== 'undefined' && JSON.parse(__firebase_config).apiKey 
        ? JSON.parse(__firebase_config) 
        : userFirebaseConfig;
        
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // ê¸€ë¡œë²Œ ìƒíƒœ
    let currentUserId = null;
    let isAuthAttempted = false; 
    let challengeId = new URLSearchParams(window.location.search).get('id');
    let challengeData = null;
    let isTeamChallenge = false;
    let userName = "ì‚¬ìš©ì" + (Math.random() * 1000).toFixed(0); // ì„ì‹œ ì‚¬ìš©ìëª…

    // --- UI/UX í•¨ìˆ˜ (Modal) ---
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    
    window.showModal = function(title, text) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.querySelector('.modal-content').style.transform = 'scale(1)';
            modal.querySelector('.modal-content').style.opacity = '1';
        }, 10); 
    }

    window.hideModal = function() {
        modal.querySelector('.modal-content').style.transform = 'scale(0.9)';
        modal.querySelector('.modal-content').style.opacity = '0';
        setTimeout(() => {
            modal.style.display = 'none';
        }, 200); 
    }

    /**
     * íƒ­ ì „í™˜ ë° ì½˜í…ì¸  í‘œì‹œë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     */
    window.showTab = function(tabName) {
        // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ ì½˜í…ì¸  ë¹„í™œì„±í™”
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // ì„ íƒëœ íƒ­ í™œì„±í™”
        const activeTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
        const activeTabContent = document.getElementById(`${tabName}-tab`);

        if (activeTabButton) activeTabButton.classList.add('active');
        if (activeTabContent) activeTabContent.classList.add('active');

        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì´ˆê¸°í™”
        document.getElementById('challenge-view').scrollTop = 0;
    }
    
    // --- ì±Œë¦°ì§€ ìƒì„¸ ë°ì´í„° ë¡œë“œ ---
    
    /**
     * ì±Œë¦°ì§€ ë°ì´í„°ë¥¼ ëª¨í‚¹/ë¡œë”©í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    function loadChallengeDetails(data) {
        if (!data) {
             // ì±Œë¦°ì§€ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ í‘œì‹œ
             document.getElementById('challenge-title').textContent = "ì±Œë¦°ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
             document.getElementById('challenge-description').textContent = "ìœ íš¨í•˜ì§€ ì•Šì€ ì±Œë¦°ì§€ IDì…ë‹ˆë‹¤.";
             return;
        }

        challengeData = data;
        isTeamChallenge = data.isTeam;
        
        document.getElementById('challenge-title').textContent = data.title;
        document.getElementById('challenge-description').textContent = data.description;
        document.getElementById('challenge-type').textContent = data.isTeam ? 'íŒ€ ì±Œë¦°ì§€ ğŸ¤' : 'ê°œì¸ ì±Œë¦°ì§€ ğŸƒ';
        document.getElementById('challenge-status').textContent = `D-${data.daysRemaining} | ${data.progress}% ë‹¬ì„±`;

        // íŒ€ ì±Œë¦°ì§€ì¼ ê²½ìš°ì—ë§Œ ì±„íŒ… íƒ­ í‘œì‹œ ë° ì±„íŒ… ê¸°ëŠ¥ ì‹œì‘
        if (isTeamChallenge) {
            document.getElementById('chat-tab-button').style.display = 'block';
            fetchChatMessages();
        } else {
            document.getElementById('chat-tab-button').style.display = 'none';
        }
        
        // ì§„í–‰ ê¸°ë¡ ë¡œë“œ (Solo/Team ê³µí†µ)
        fetchProgressLogs();
    }
    
    /**
     * ì±Œë¦°ì§€ ë°ì´í„°ë¥¼ Firestoreì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
     * (ë°ëª¨ë¥¼ ìœ„í•´ Team/Solo IDì— ë”°ë¼ Mock Data ë¡œë“œ)
     */
    function fetchChallengeDetails() {
        if (!challengeId) {
            loadChallengeDetails(null);
            return;
        }
        
        // Mocking logic based on ID for demo purposes
        let mockData;
        if (challengeId === 'C-TEAM-456') {
             mockData = {
                id: challengeId,
                title: "ë§¤ì¼ ì½”ë”© 1ì‹œê°„! ğŸ’»",
                description: "íŒ€ì›ë“¤ê³¼ í•¨ê»˜ ë§¤ì¼ ë°¤ 10ì‹œì— ì½”ë”© ìŠ¤í„°ë”” ì¸ì¦ì„ ì§„í–‰í•©ë‹ˆë‹¤. 100ì¼ê°„ ê¾¸ì¤€íˆ!",
                isTeam: true,
                daysRemaining: 95,
                progress: 5
             };
        } else {
             // Default Solo Mock
             mockData = {
                id: challengeId,
                title: "ì•„ì¹¨ 6ì‹œ ê¸°ìƒ ğŸŒ",
                description: "ë‚˜ ìì‹ ê³¼ì˜ ì‹¸ì›€! 30ì¼ ë™ì•ˆ ë§¤ì¼ ì•„ì¹¨ 6ì‹œì— ì¼ì–´ë‚˜ ì¸ì¦ ì‚¬ì§„ì„ ë‚¨ê¹ë‹ˆë‹¤.",
                isTeam: false,
                daysRemaining: 15,
                progress: 50
             };
        }
        
        loadChallengeDetails(mockData);
        // ì‹¤ì œ Firestore ë¡œì§ì€ onSnapshotìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.
        // const challengeRef = doc(db, `/artifacts/${appId}/public/data/challenges/${challengeId}`);
        // onSnapshot(challengeRef, (doc) => { if(doc.exists()) loadChallengeDetails(doc.data()); });
    }

    // --- ì§„í–‰ ê¸°ë¡ ê¸°ëŠ¥ ---

    /**
     * ì§„í–‰ ê¸°ë¡ì„ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    window.recordProgress = async function() {
        if (!currentUserId || !challengeId) return showModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ ë˜ëŠ” ì±Œë¦°ì§€ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');

        const progressInput = document.getElementById('progress-input');
        const content = progressInput.value.trim();

        if (content.length < 5) {
            return showModal('ê²½ê³ ', 'ê¸°ë¡ ë‚´ìš©ì„ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
        
        try {
            // Private data path: /artifacts/{appId}/users/{userId}/progress_logs
            const path = `/artifacts/${appId}/users/${currentUserId}/progress_logs`;
            await addDoc(collection(db, path), {
                challengeId: challengeId,
                userId: currentUserId,
                userName: userName,
                content: content,
                timestamp: serverTimestamp()
            });
            progressInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            showModal('ì„±ê³µ', 'ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
            console.error("Progress Record Error:", error);
            showModal('ì˜¤ë¥˜', 'ê¸°ë¡ ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    /**
     * ì§„í–‰ ê¸°ë¡ ëª©ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì™€ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function fetchProgressLogs() {
        if (!currentUserId || !challengeId) return;

        // Private data path: /artifacts/{appId}/users/{userId}/progress_logs
        const path = `/artifacts/${appId}/users/${currentUserId}/progress_logs`; 
        const logsRef = collection(db, path);
        
        // í˜„ì¬ ì±Œë¦°ì§€ì— í•´ë‹¹í•˜ëŠ” ê¸°ë¡ë§Œ ê°€ì ¸ì˜¤ë©°, ìµœì‹ ìˆœ ì •ë ¬
        const q = query(
            logsRef, 
            // Note: orderBy is used for simple querying but for large datasets, sort in client-side to avoid index issues.
            // For demo, we are showing the intent.
            // You may need to remove orderBy in production if performance degrades.
            // where('challengeId', '==', challengeId), // ì±Œë¦°ì§€ID í•„í„°ë§ (Firestore Ruleì—ì„œ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆìŒ)
            orderBy('timestamp', 'desc')
        );
        
        const listContainer = document.getElementById('progress-log-list');
        listContainer.innerHTML = '';
        listContainer.innerHTML = '<p style="text-align: center; color: #777;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

        onSnapshot(q, (snapshot) => {
            listContainer.innerHTML = ''; 
            let logsFound = false;
            
            snapshot.forEach((doc) => {
                const log = doc.data();
                if (log.challengeId === challengeId) { // í´ë¼ì´ì–¸íŠ¸ ì¸¡ í•„í„°ë§ ì¶”ê°€
                    logsFound = true;
                    const logItem = document.createElement('div');
                    logItem.className = 'progress-log-item';
                    
                    const date = log.timestamp ? 
                        new Date(log.timestamp.toDate()).toLocaleDateString('ko-KR', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 
                        'ë°©ê¸ˆ ì „';
                        
                    logItem.innerHTML = `
                        <div class="log-date">${date} (${log.userName})</div>
                        <div class="log-content">${log.content}</div>
                    `;
                    listContainer.appendChild(logItem);
                }
            });

            if (!logsFound) {
                listContainer.innerHTML = '<p style="text-align: center; color: #aaa; padding: 2rem 0;">ì•„ì§ ê¸°ë¡ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

        }, (error) => {
            console.error("Progress Log Error:", error);
            listContainer.innerHTML = '<p style="text-align: center; color: #ff4d4d;">ê¸°ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>';
        });
    }

    // --- íŒ€ ë©”ì‹ ì € ê¸°ëŠ¥ ---

    /**
     * ì±„íŒ… ë©”ì‹œì§€ë¥¼ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    window.sendMessage = async function() {
        if (!currentUserId || !challengeId || !isTeamChallenge) return;

        const chatInput = document.getElementById('chat-input');
        const content = chatInput.value.trim();

        if (!content) return;
        
        try {
            // Public data path: /artifacts/{appId}/public/data/challenges/{challengeId}/chat
            const path = `/artifacts/${appId}/public/data/challenges/${challengeId}/chat`; 
            await addDoc(collection(db, path), {
                challengeId: challengeId,
                userId: currentUserId,
                userName: userName,
                content: content,
                timestamp: serverTimestamp()
            });
            chatInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        } catch (error) {
            console.error("Chat Send Error:", error);
            showModal('ì˜¤ë¥˜', 'ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    /**
     * Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
     */
    window.handleChatKeydown = function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    }

    /**
     * ì±„íŒ… ë©”ì‹œì§€ ëª©ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì™€ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function fetchChatMessages() {
        if (!challengeId || !isTeamChallenge) return;

        // Public data path: /artifacts/{appId}/public/data/challenges/{challengeId}/chat
        const path = `/artifacts/${appId}/public/data/challenges/${challengeId}/chat`;
        const chatRef = collection(db, path);
        
        // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
        const q = query(chatRef, orderBy('timestamp', 'asc')); 

        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = '<p style="text-align: center; color: #777;">ì±„íŒ… ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

        onSnapshot(q, (snapshot) => {
            messagesContainer.innerHTML = '';
            
            snapshot.forEach((doc) => {
                const msg = doc.data();
                const isMine = msg.userId === currentUserId;
                
                const messageBox = document.createElement('div');
                messageBox.className = `message-box ${isMine ? 'mine' : 'theirs'}`;

                const messageBlock = document.createElement('div');
                messageBlock.className = 'message';
                
                // ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„ í‘œì‹œ (ë‚´ ë©”ì‹œì§€ì—ëŠ” ì´ë¦„ë§Œ í‘œì‹œ)
                const senderName = msg.userName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                messageBlock.innerHTML = `
                    <span class="message-sender">${isMine ? senderName : senderName}</span>
                    ${msg.content}
                `;
                
                messageBox.appendChild(messageBlock);
                messagesContainer.appendChild(messageBox);
            });
            
            // í•­ìƒ ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

        }, (error) => {
            console.error("Chat Fetch Error:", error);
            messagesContainer.innerHTML = '<p style="text-align: center; color: #ff4d4d;">ì±„íŒ… ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>';
        });
    }

    // --- ì¸ì¦ ë° ì´ˆê¸°í™” ---

    /**
     * ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸° ë°ì´í„° ë¡œë“œ
     */
    onAuthStateChanged(auth, async (user) => {
        if (!isAuthAttempted) {
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            isAuthAttempted = true; 

            if (!user && initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    return; 
                } catch (error) {
                    console.error("Custom token login failed. Forcing redirect to /auth", error);
                    window.location.href = "/auth"; 
                    return;
                }
            } else if (!user) {
                console.warn("User not authenticated. Redirecting to /auth");
                window.location.href = "/auth"; 
                return; 
            }
        }

        if (user) {
            currentUserId = user.uid;
            
            // ì„ì‹œ ì‚¬ìš©ìëª… ì„¤ì • (ì‹¤ì œ ì•±ì—ì„œëŠ” ì‚¬ìš©ì í”„ë¡œí•„ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
            const userShortId = user.uid.substring(0, 4);
            userName = `User-${userShortId}`; 
            
            // ì±Œë¦°ì§€ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹œì‘
            fetchChallengeDetails(); 

        } else if (isAuthAttempted) {
             console.warn("Authentication failed or logged out. Redirecting to /auth");
             window.location.href = "/auth"; 
             return;
        }
        
        // í°íŠ¸ ë¡œë“œ í™•ì¸ í›„ ì•± ì»¨í…Œì´ë„ˆ í‘œì‹œ
        document.fonts.ready.then(() => {
             document.getElementById('app-container').classList.add('font-loaded');
        });
    });


    // --- ì´ˆê¸°í™” ë¡œì§ ---
    window.addEventListener('load', () => {
        if (!challengeId) {
             showModal('ì˜¤ë¥˜', 'ì ‘ê·¼í•  ì±Œë¦°ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ íš¨í•œ IDë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.');
        }

        const appContainer = document.getElementById('app-container');
        appContainer.style.minHeight = `${window.innerHeight}px`;
        
        window.addEventListener('resize', () => {
            appContainer.style.minHeight = `${window.innerHeight}px`;
        });
        
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥ ì¶”ê°€
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                hideModal();
            }
        });
    });
</script>
</body>
</html>
