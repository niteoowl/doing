<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"> 
    <title>Doing! - 챌린지</title>
    <link rel="icon" type="image/x-icon" href="/image/favicon.ico">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --color-accent: #1E90FF; /* 포인트 블루 */
            --bottom-nav-height: 65px; 
            --pc-max-width: 1200px; 
            --header-height: 4.5rem; 
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Pretendard Variable', Pretendard, sans-serif;
            margin: 0; padding: 0; background-color: #ffffff; 
            min-height: 100vh; color: #000000; display: flex; justify-content: center;
        }

        #app-container {
            width: 100%; max-width: var(--pc-max-width); 
            display: flex; flex-direction: column; min-height: 100vh;
            opacity: 0; transition: opacity 0.5s ease;
        }
        #app-container.font-loaded { opacity: 1; }

        .view {
            padding: 1.5rem 1.5rem; 
            padding-bottom: calc(1.5rem + var(--bottom-nav-height) + max(0px, env(safe-area-inset-bottom))); 
            padding-top: 0; 
        }

        /* 헤더 & 탭 */
        .main-header {
            font-size: 1.75rem; font-weight: 800; display: flex; align-items: center; 
            min-height: var(--header-height); padding: 0 1.5rem; position: sticky; top: 0;
            z-index: 10; background-color: #ffffff; justify-content: flex-start; gap: 1.5rem;
        }
        .main-tab-item { 
            font-weight: 800; color: #ccc; cursor: pointer; position: relative; transition: color 0.2s ease; 
            padding-bottom: 5px; 
        }
        .main-tab-item.active { color: #000000; }
        
        .create-button-container { margin-left: auto; }
        .create-challenge-icon {
            background: none; border: none; color: #000000; font-size: 28px; cursor: pointer; 
            padding: 8px; border-radius: 50%; transition: background-color 0.1s;
        }
        .create-challenge-icon:hover { background-color: #f0f0f0; }

        /* 하단 네비게이션 */
        .bottom-nav {
            width: 100%; height: var(--bottom-nav-height); background-color: #ffffff;
            display: flex; justify-content: space-around; align-items: center; z-index: 20;
            position: fixed; bottom: 0; border-top: 1px solid #e0e0e0; left: 0;
            padding-bottom: max(0px, env(safe-area-inset-bottom)); max-width: var(--pc-max-width);
            transform: translateX(0%); left: 50%; transform: translateX(-50%);
        }
        .nav-item {
            color: #999; text-decoration: none; display: flex; flex-direction: column; 
            align-items: center; font-size: 0.75rem; padding: 0.75rem 0.5rem; border-radius: 12px;
        }
        .nav-item.active { color: var(--color-accent); font-weight: 600; }
        .nav-item i.material-icons { font-size: 24px; margin-bottom: 2px; }

        /* 리스트 아이템 */
        .challenge-list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 1rem 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;
        }
        .challenge-list-item:last-child { border-bottom: none; }
        
        .challenge-main-content { display: flex; flex-direction: column; flex-grow: 1; }
        .challenge-list-item h3 { font-size: 1.25rem; font-weight: 700; margin: 0; }
        .challenge-type-badge { font-size: 0.75rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; align-self: flex-start; }
        .type-personal { background-color: #e0f2fe; color: #0284c7; } /* Sky Blue */
        .type-team { background-color: #d1fae5; color: #059669; } /* Emerald Green */

        .challenge-detail-text { font-size: 0.85rem; color: #888; margin-top: 4px; }

        .team-info-wrap { 
            width: 56px; height: 56px; border-radius: 50%; background-color: #f5f5f5; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            flex-shrink: 0; margin-left: 1rem;
        }
        .team-info-wrap i.material-icons { font-size: 30px; color: #3b82f6; }
        .team-count { font-size: 0.875rem; font-weight: 700; color: #000000; margin-top: -3px; }

        /* 상태 텍스트 (개인 챌린지용) */
        .status-joined { color: #10b981; } 
        .status-not-joined { color: #d94b4b; }

        /* 빈 상태 */
        .empty-state-content { 
            margin-top: 3rem; text-align: center;
        }
        .empty-state-content img { width: 120px; height: auto; margin-bottom: 20px; }
        .empty-state-content p { font-size: 1.1rem; font-weight: 600; color: #4b5563; margin-bottom: 20px; }
        .action-button { 
            width: 100%; max-width: 250px; padding: 0.75rem 1.5rem; 
            background-color: #000000; color: #ffffff; border: none; border-radius: 9999px; 
            font-size: 1rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s; 
        }

        /* 탐색 탭 스타일 */
        #explore-search {
            width: 100%; padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 12px;
            font-size: 1rem; margin-top: 1.5rem; outline: none; transition: border-color 0.2s;
        }
        #explore-search:focus { border-color: var(--color-accent); }
        .filter-tags { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .filter-tag {
            background-color: #f0f0f0; color: #4b5563; border: none; border-radius: 9999px;
            padding: 6px 14px; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s;
        }
        .filter-tag:hover { background-color: #e0e0e0; }
        .explore-info-text { margin-top: 3rem; text-align: center; color: #888; font-size: 1rem; }
        
        /* 스켈레톤 스타일 */
        .skeleton-loader {
            animation: loading-shimmer 1.5s infinite linear;
            background: #f6f7f9;
            background-image: linear-gradient(to right, #f6f7f9 0%, #e9ebee 20%, #f6f7f9 40%, #f6f7f9 100%);
            background-repeat: no-repeat; background-size: 800px 104px; height: 100%; border-radius: 8px;
            display: inline-block;
        }
        @keyframes loading-shimmer {
            0% { background-position: -468px 0 }
            100% { background-position: 468px 0 }
        }
        .skeleton-item { display: flex; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f0f0f0; }
        .skeleton-info { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
        .skeleton-title { height: 20px; width: 60%; }
        .skeleton-detail { height: 14px; width: 40%; }
        .skeleton-icon { width: 56px; height: 56px; border-radius: 50%; margin-left: 1rem; }
        
        /* Ripple & Modal */
        .interactive { position: relative; overflow: hidden; transform: translate3d(0, 0, 0); }
        .ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple-animation 0.5s linear; background-color: rgba(0, 0, 0, 0.1); pointer-events: none; z-index: 100; }
        @keyframes ripple-animation { to { transform: scale(4); opacity: 0; } }
        #modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #ffffff; padding: 30px; padding-bottom: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); width: 90%; max-width: 400px; text-align: center; transform: scale(0.9); opacity: 0; transition: all 0.2s ease-out; }
        .modal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; }
        .modal-text { font-size: 1rem; margin-bottom: 20px; line-height: 1.4; color: #333; }
        #modal-close-button { width: 100%; padding: 0.75rem; margin-top: 10px; background-color: var(--color-accent); color: #ffffff; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; }

        @media (min-width: 640px) {
            .main-header { padding: 0 3rem; gap: 2rem; }
            .view { padding: 1.5rem 3rem; padding-bottom: calc(1.5rem + var(--bottom-nav-height)); }
        }
    </style>
</head>
<body>

<div id="app-container">
    <!-- 하단 내비게이션 바 -->
    <div class="bottom-nav">
        <a class="nav-item interactive" href="/">
            <i class="material-icons">home</i> <span>홈</span>
        </a>
        <a class='nav-item interactive active' href='/challenge'>
            <i class="material-icons">local_fire_department</i> <span>챌린지</span>
        </a>
        <a class="nav-item interactive" href="/my">
            <i class="material-icons">person</i> <span>마이</span>
        </a>
    </div>

    <!-- 상단 탭 전환 및 생성 버튼 -->
    <header class="main-header" id="main-header">
        <!-- onclick은 이제 스크립트에서 window.switchTopTab에 연결된 함수를 호출합니다. -->
        <div id="tab-my-btn" class="main-tab-item interactive active" onclick="switchTopTab('my')">내 챌린지</div>
        <!-- 팀 챌린지 탐색 탭 -->
        <div id="tab-explore-btn" class="main-tab-item interactive" onclick="switchTopTab('explore')">탐색</div>
        <!-- 챌린지 생성 버튼 -->
        <div class="create-button-container">
            <button class="create-challenge-icon interactive" onclick="showModal('챌린지 생성', '개인 또는 팀 챌린지 생성 페이지로 이동합니다.')">
                <i class="material-icons">add</i>
            </button>
        </div>
    </header>
    
    <!-- 뷰 컨테이너 -->
    <div id="challenge-view" class="view">
        
        <!-- 1. 내 챌린지 탭 내용 -->
        <div id="tab-content-my">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-top: 0; margin-bottom: 1rem;">나의 도전 목록</h2>
            <div id="my-challenge-list" class="challenge-list" style="display: none;"></div>
            <div id="my-challenge-skeleton" class="challenge-list"></div>
            <!-- 내 챌린지가 없을 때 표시되는 빈 상태 -->
            <div id="my-challenge-empty-state" style="display: none;">
                <div class="empty-state-content">
                    <img src="https://placehold.co/120x120/f0f9ff/1d4ed8?text=CHECK" alt="체크리스트 이미지"
                         onerror="this.onerror=null; this.src='https://placehold.co/120x120/f7e0c4/966A45?text=BOX';"/>
                    <p>아직 참여중인 챌린지가 없어요</p>
                    <button class="action-button interactive" onclick="switchTopTab('explore');">
                        새로운 팀 챌린지 탐색하기
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 2. 탐색 탭 내용 (검색 및 필터) -->
        <div id="tab-content-explore" style="display: none;"> 
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-top: 0; margin-bottom: 1rem;">팀 챌린지 탐색</h2>
            <div class="search-filter-section">
                <input type="search" id="explore-search" placeholder="제목, 태그, 카테고리, 생성자 등으로 검색" oninput="filterAndRenderExploreChallenges(this.value)">
                <div class="filter-tags">
                    <button class="filter-tag interactive" onclick="filterAndRenderExploreChallenges('드로잉')">#드로잉/그림</button>
                    <button class="filter-tag interactive" onclick="filterAndRenderExploreChallenges('운동')">#운동</button>
                    <button class="filter-tag interactive" onclick="filterAndRenderExploreChallenges('독서')">#독서</button>
                    <button class="filter-tag interactive" onclick="filterAndRenderExploreChallenges('')">#모두 보기</button>
                </div>
            </div>

            <!-- 탐색 결과 -->
            <div id="explore-results-container" class="challenge-list" style="margin-top: 2rem;">
                 <div class="skeleton-item"><div class="skeleton-info"><div class="skeleton-title skeleton-loader"></div><div class="skeleton-detail skeleton-loader"></div></div><div class="skeleton-icon skeleton-loader"></div></div>
                 <div class="skeleton-item"><div class="skeleton-info"><div class="skeleton-title skeleton-loader"></div><div class="skeleton-detail skeleton-loader"></div></div><div class="skeleton-icon skeleton-loader"></div></div>
            </div>
        </div>
    </div>
    
</div>

<!-- 모달 팝업 구조 -->
<div id="modal">
    <div class="modal-content">
        <h3 class="modal-title" id="modal-title"></h3>
        <p class="modal-text" id="modal-text"></p>
        <button id="modal-close-button" class="interactive" onclick="hideModal()">확인</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase 설정 및 초기화 ---
    // FirebaseConfig가 제공되지 않을 경우 기본값을 사용하여 'projectId' 누락 오류를 방지합니다.
    const firebaseConfig = typeof __firebase_config !== 'undefined'
        ? JSON.parse(__firebase_config)
        : { projectId: "placeholder-project", apiKey: "placeholder-api-key" };
        
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let currentUserId = null;
    let unsubscribeMy = []; // Array of unsubscribers for 'My Challenges'
    let unsubscribeExplore = null;
    let allExploreChallenges = []; // Global storage for all public challenges
    let currentTab = 'my';

    // --- UI/UX 함수 ---
    const modal = document.getElementById('modal');
    window.showModal = function(title, text) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-text').textContent = text;
        modal.style.display = 'flex';
        setTimeout(() => {
            const content = modal.querySelector('.modal-content');
            content.style.transform = 'scale(1)';
            content.style.opacity = '1';
        }, 10); 
    }

    window.hideModal = function() {
        const content = modal.querySelector('.modal-content');
        content.style.transform = 'scale(0.9)';
        content.style.opacity = '0';
        setTimeout(() => { modal.style.display = 'none'; }, 200); 
    }
    
    // switchTopTab 함수를 window 객체에 연결하여 HTML 인라인에서 접근 가능하도록 합니다.
    window.switchTopTab = function(tabName) {
        if (currentTab === tabName) return;
        currentTab = tabName;
        
        const tabs = ['my', 'explore'];
        tabs.forEach(name => {
            const content = document.getElementById(`tab-content-${name}`);
            const btn = document.getElementById(`tab-${name}-btn`);
            
            btn.classList.toggle('active', name === tabName);
            content.style.display = name === tabName ? 'block' : 'none';
        });
        
        // 탭 전환 시 데이터 로드/뷰 렌더링
        if (tabName === 'my') {
            fetchMyChallenges();
            if (unsubscribeExplore) { unsubscribeExplore(); unsubscribeExplore = null; }
        } else if (tabName === 'explore') {
            fetchExploreChallenges();
            unsubscribeMy.forEach(unsub => unsub());
            unsubscribeMy = [];
        }
    }
    
    function addRippleEffect(event) {
        const button = event.currentTarget;
        const ripple = document.createElement('span');
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = event.clientX - rect.left - size / 2;
        const y = event.clientY - rect.top - size / 2;

        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        ripple.classList.add('ripple');

        button.querySelectorAll('.ripple').forEach(r => r.remove());
        button.appendChild(ripple);

        ripple.addEventListener('animationend', () => { ripple.remove(); });
    }
    
    function generateSkeleton(skeletonId, count = 4) {
        const container = document.getElementById(skeletonId);
        if (!container) return;

        container.innerHTML = '';
        container.style.display = 'block';

        for (let i = 0; i < count; i++) {
            const item = document.createElement('div');
            item.className = 'skeleton-item';
            item.innerHTML = `
                <div class="skeleton-info">
                    <div class="skeleton-title skeleton-loader"></div>
                    <div class="skeleton-detail skeleton-loader"></div>
                </div>
                <div class="skeleton-icon skeleton-loader"></div>
            `;
            container.appendChild(item);
        }
    }

    function renderChallenges(listId, challenges) {
        const listContainer = document.getElementById(listId);
        listContainer.innerHTML = ''; 
        listContainer.classList.add('challenge-list');
        
        challenges.forEach(challenge => {
            const durationDays = challenge.durationDays || 30;
            const participantsCount = challenge.participantIds ? challenge.participantIds.length : (challenge.participants ? challenge.participants.length : 1);
            const type = challenge.type || (challenge.isPublic ? 'team' : 'personal'); // Fallback
            
            // Proof history logic is complex; simplify to a basic count for display
            const successCount = Object.keys(challenge.proofHistory || {}).length; 

            const card = document.createElement('div');
            card.className = 'challenge-list-item interactive';
            card.setAttribute('onclick', `showModal('${challenge.title}', '챌린지 타입: ${type === 'personal' ? '개인' : '팀'} | 생성자: ${challenge.creatorName || '알 수 없음'} | 현재 ${participantsCount}명 참여 중')`);

            card.innerHTML = `
                <div class="challenge-main-content">
                    <div class="challenge-type-badge type-${type}">
                        ${type === 'personal' ? '개인 챌린지' : '팀 챌린지'}
                    </div>
                    <h3>${challenge.title}</h3>
                    <p class="challenge-detail-text">
                        ${challenge.categories ? challenge.categories.join(', ') : '카테고리 없음'}
                        · ${challenge.startDate ? challenge.startDate.split('T')[0] : '날짜 미정'} 시작
                    </p>
                </div>
                <div class="team-info-wrap" title="참여자 수">
                    <i class="material-icons">group</i>
                    <span class="team-count">${participantsCount}</span>
                </div>
            `;
            listContainer.appendChild(card);
        });
    }

    // --- 1. 내 챌린지 탭 로직 (개인 + 참여중인 팀 챌린지) ---
    function fetchMyChallenges() {
        if (!currentUserId) return;
        unsubscribeMy.forEach(unsub => unsub()); // 기존 리스너 해제
        unsubscribeMy = [];

        const listContainer = document.getElementById('my-challenge-list');
        const emptyState = document.getElementById('my-challenge-empty-state');
        const skeletonContainer = document.getElementById('my-challenge-skeleton');

        // 로딩 시작: 스켈레톤 표시
        generateSkeleton('my-challenge-skeleton', 3);
        listContainer.style.display = 'none';
        emptyState.style.display = 'none';

        let personalChallenges = [];
        let joinedTeamChallenges = [];
        let isPersonalReady = false;
        let isJoinedReady = false;

        function updateMyUI() {
            if (isPersonalReady && isJoinedReady) {
                const allChallenges = [...personalChallenges, ...joinedTeamChallenges];
                
                // ID를 기준으로 중복 제거 (set을 사용하여 unique한 ID만 남김)
                const uniqueIds = new Set(allChallenges.map(c => c.id));
                const uniqueChallenges = Array.from(uniqueIds).map(id => 
                    allChallenges.find(c => c.id === id) // 첫 번째 발견된 객체 사용
                );

                skeletonContainer.style.display = 'none'; // 로딩 완료
                
                if (uniqueChallenges.length === 0) {
                    listContainer.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    listContainer.style.display = 'block';
                    emptyState.style.display = 'none';
                    renderChallenges('my-challenge-list', uniqueChallenges);
                }
            }
        }

        // 1. 개인 챌린지 (사용자 폴더)
        const personalPath = `/artifacts/${appId}/users/${currentUserId}/challenges`;
        const personalRef = collection(db, personalPath);

        const unsubPersonal = onSnapshot(personalRef, (snapshot) => {
            personalChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'personal' }));
            isPersonalReady = true;
            updateMyUI();
        }, (error) => {
            console.error("Firestore Personal Challenges Error:", error);
            isPersonalReady = true;
            updateMyUI();
        });
        unsubscribeMy.push(unsubPersonal);

        // 2. 참여중인 팀 챌린지 (공개 데이터 폴더)
        const teamPath = `/artifacts/${appId}/public/data/team_challenges`;
        const teamRef = collection(db, teamPath);
        // participantIds 배열에 현재 userId가 포함된 팀 챌린지 쿼리
        const teamQ = query(teamRef, where('participantIds', 'array-contains', currentUserId));
        
        const unsubJoined = onSnapshot(teamQ, (snapshot) => {
            joinedTeamChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'team' }));
            isJoinedReady = true;
            updateMyUI();
        }, (error) => {
            console.error("Firestore Joined Team Challenges Error:", error);
            isJoinedReady = true;
            updateMyUI();
        });
        unsubscribeMy.push(unsubJoined);
    }

    // --- 2. 탐색 탭 로직 (모든 팀 챌린지 검색/필터) ---
    // window에 연결하여 HTML 인라인 이벤트에서도 접근 가능하게 합니다.
    window.filterAndRenderExploreChallenges = function(searchText) {
        const term = searchText.toLowerCase().trim();
        const resultsContainer = document.getElementById('explore-results-container');
        resultsContainer.innerHTML = '';
        
        const filtered = allExploreChallenges.filter(challenge => {
            if (!term) return true; // 검색어가 없으면 모두 표시

            // 검색 필드: title, creatorName, tags, categories, goalsList
            const searchPool = [
                challenge.title, 
                challenge.creatorName, 
                ...(challenge.tags || []),
                ...(challenge.categories || []),
                ...(challenge.goalsList || [])
            ].map(s => String(s).toLowerCase());
            
            return searchPool.some(field => field.includes(term));
        });

        if (filtered.length === 0) {
            resultsContainer.innerHTML = `<p class="explore-info-text">${term ? `'${term}'에 해당하는 챌린지가 없습니다.` : '현재 공개된 팀 챌린지가 없습니다.'}</p>`;
        } else {
            renderChallenges('explore-results-container', filtered);
        }
    }

    function fetchExploreChallenges() {
        if (unsubscribeExplore) unsubscribeExplore();

        const teamPath = `/artifacts/${appId}/public/data/team_challenges`;
        const teamRef = collection(db, teamPath);
        // 공개된 챌린지 (`isPublic: true`)만 쿼리
        const teamQ = query(teamRef, where('isPublic', '==', true)); 
        
        generateSkeleton('explore-results-container', 4); // 로딩 스켈레톤 표시

        unsubscribeExplore = onSnapshot(teamQ, (snapshot) => {
            // 모든 공개 챌린지를 전역 변수에 저장 (클라이언트 측 검색용)
            allExploreChallenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'team' }));
            
            // 로딩 완료 후, 검색어를 초기화하여 전체 목록 렌더링
            document.getElementById('explore-search').value = '';
            filterAndRenderExploreChallenges(''); 
        }, (error) => {
            console.error("Firestore Explore Challenges Error:", error);
            showModal('데이터 오류', '탐색 챌린지 목록을 불러오는 중 오류가 발생했습니다.');
            document.getElementById('explore-results-container').innerHTML = '<p class="explore-info-text">데이터 로드 실패.</p>';
        });
    }

    // --- 인증 및 초기화 ---
    onAuthStateChanged(auth, async (user) => {
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (!user && initialAuthToken) {
            try {
                // 커스텀 토큰으로 로그인 시도
                await signInWithCustomToken(auth, initialAuthToken);
                return;
            } catch (error) {
                console.error("Auth failed. Redirecting to /auth", error);
                // 오류 발생 시 익명 로그인으로 대체하거나 /auth로 리디렉션
                // window.location.href = "/auth";
                return;
            }
        } else if (!user) {
            // 커스텀 토큰이 없거나 로그인 실패 시 익명 로그인 시도
            try {
                 await getAuth(app).signInAnonymously();
            } catch (error) {
                 console.error("Anonymous sign in failed.", error);
                 //window.location.href = "/auth"; // 익명 로그인도 실패하면 리디렉션
                 return;
            }
        }

        // 인증 성공 후 사용자 ID 설정
        if (auth.currentUser) {
            currentUserId = auth.currentUser.uid;
            // 초기 로드는 'my' 탭
            fetchMyChallenges();
        }
        
        // 폰트 로드 확인 후 앱 컨테이너 표시
        document.fonts.ready.then(() => {
             document.getElementById('app-container').classList.add('font-loaded');
        });
    });


    // --- 초기화 로직 ---
    window.addEventListener('load', () => {
        // 모바일 스크롤 이슈 대응
        const appContainer = document.getElementById('app-container');
        appContainer.style.minHeight = `${window.innerHeight}px`;
        window.addEventListener('resize', () => { appContainer.style.minHeight = `${window.innerHeight}px`; });
        
        // 모달 배경 클릭 시 닫기
        modal.addEventListener('click', (event) => { if (event.target === modal) { hideModal(); } });
        
        // Ripple Effect 초기화
        document.querySelectorAll('.interactive').forEach(button => {
            button.addEventListener('mousedown', (event) => { setTimeout(() => addRippleEffect(event), 0); });
        });
    });
</script>
</body>
</html>
