<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB 뷰어</title>
    <!-- JSZip 라이브러리 로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- epub.js 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        /* ==================================== */
        /* 1. 기본 스타일 (라이트 모드 고정) */
        /* ==================================== */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #F8F8F8; /* 밝은 배경 고정 */
            color: #333;
        }

        #app-container {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #top-bar {
            padding: 10px;
            background: linear-gradient(to bottom, #4A90E2 0%, #357ABD 100%);
            color: white;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 파일 입력 그룹 */
        #file-input-group {
            display: flex;
            align-items: center;
            flex-grow: 1;
            margin-right: 10px;
        }

        .mobile-button {
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: white;
            transition: background-color 0.2s, box-shadow 0.1s;
            border-radius: 4px;
            text-align: center;
            background: linear-gradient(to bottom, #7CD3F2 0%, #4FA3D3 100%);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        #epub-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        
        #file-name-display {
            flex-grow: 1;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 14px;
            color: #E0E0E0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            min-width: 0;
        }

        #book-viewer {
            flex-grow: 1;
            background-color: white;
            overflow: hidden;
        }

        #bottom-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 10px;
            background: linear-gradient(to top, #EAEAEA 0%, #F5F5F5 100%);
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
            min-height: 44px; /* 최소 높이 확보 */
        }

        #page-status {
            font-size: 14px;
            color: #555;
            text-align: center;
            font-weight: 500;
            padding: 0 15px;
        }
        
        #loading-message {
            text-align: center;
            padding: 50px;
            font-size: 16px;
            color: #4A90E2;
        }
    </style>
</head>
<body id="body">

<div id="app-container">
    <div id="top-bar">
        <div id="controls">
            <div id="file-input-group">
                <span id="file-name-display">선택된 파일 없음</span>
                <input type="file" id="epub-file-input" accept=".epub">
                <label for="epub-file-input" class="mobile-button">파일 선택</label>
            </div>
            <!-- 다크 모드 토글 버튼 삭제됨 -->
        </div>
        <div id="book-title" style="font-size: 13px;">현재 로드된 책: 없음</div>
    </div>

    <div id="book-viewer">
        <div id="loading-message">
            EPUB 파일을 보려면 '파일 선택' 버튼을 눌러 로컬 파일을 업로드하세요.<br>
            뷰어는 **밝은 모드(Light Mode) 페이지 넘기기**로 고정되어 있습니다.
        </div>
        <!-- EPUB 내용이 여기에 렌더링됩니다 -->
    </div>

    <div id="bottom-controls">
        <span id="page-status"></span>
    </div>
</div>

<script>
    // 전역 변수 설정
    let book;
    let rendition;
    let startX = 0; // 스와이프 시작 X 좌표
    const SWIPE_THRESHOLD = 70; // 스와이프 최소 거리 (픽셀)
    
    // UI 요소 가져오기
    const viewer = document.getElementById('book-viewer');
    const pageStatus = document.getElementById('page-status');
    const bookTitleElement = document.getElementById('book-title');
    const fileInput = document.getElementById('epub-file-input');
    const fileNameDisplay = document.getElementById('file-name-display');

    // ====================================
    // 1. 라이트 모드 강제 적용 설정
    // ====================================

    // EPUBJS의 기본 라이트 모드 테마 정의. !important를 사용하여 우선순위를 높여 검정 텍스트 문제를 방지합니다.
    const lightTheme = {
        'body': {
            'background': 'white !important', // 배경색 흰색 강제 적용
            'color': '#333 !important' // 기본 글자색 검정 계열 강제 적용
        },
        // 주요 텍스트 태그에 강제로 스타일 적용
        'p, span, div, li, td, th': { 'color': '#333 !important' }, 
        'h1, h2, h3, h4, h5, h6': { 'color': '#333 !important' },
        '*': { 'color': '#333 !important' }, // 모든 요소의 글자색을 검정 계열로 설정 (최후의 수단)
        'a': { 'color': '#4A90E2 !important' }, // 링크 색상
    };


    /** 항상 라이트 테마를 렌디션에 적용 */
    function applyLightTheme() {
        if (!rendition) return;
        rendition.themes.override(lightTheme);
    }
    
    // ====================================
    // 2. EPUB 로드 및 렌더링 기능
    // ====================================
    
    // 경고 메시지 함수 (alert() 대체)
    function showCustomAlert(message) {
        console.warn("경고:", message);
        const errorElement = document.createElement('div');
        errorElement.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fef2f2; border: 1px solid #ef4444; color: #b91c1c; padding: 15px 25px; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 14px;';
        errorElement.textContent = message;
        document.body.appendChild(errorElement);
        setTimeout(() => document.body.removeChild(errorElement), 3000);
    }

    /** 현재 위치 정보를 분석하여 하단 상태 표시줄을 업데이트합니다. */
    function updatePageStatus(location) {
        if (!location) {
            pageStatus.textContent = "위치 정보 없음";
            return;
        }

        // 페이지 모드 (Paginated) 전용 로직
        const totalPages = location.total;
        const displayed = location.displayed;
        
        // displayed 배열에서 첫 번째 페이지 번호를 안전하게 가져옴
        const currentPage = (Array.isArray(displayed) && displayed.length > 0) ? displayed[0].page : undefined;

        if (totalPages && totalPages > 0 && currentPage !== undefined) {
            pageStatus.textContent = `페이지 ${currentPage + 1} / ${totalPages}`;
        } else if (location.percentage !== undefined) {
             // 페이지 계산 중이거나 오류 시 퍼센티지 폴백
            const percentage = location.percentage * 100;
            pageStatus.textContent = `읽는 중... ${percentage.toFixed(1)}%`;
        } else {
            pageStatus.textContent = "페이지 정보 로딩 중...";
        }
    }
    
    /** 렌디션 이벤트 리스너 설정 및 강제 스타일 적용 훅 등록 */
    function setupRenditionListeners() {
        if (!rendition) return;

        // 콘텐츠가 로드될 때마다 라이트 테마를 강제로 다시 적용하는 훅 등록
        rendition.hooks.content.register((contents) => {
            applyLightTheme(); 
        });

        // 페이지 변경 시 상태 업데이트
        rendition.on("relocated", updatePageStatus);
        
        // 초기 페이지 상태 업데이트 (rendered 이벤트 후)
        rendition.on("rendered", () => {
            const location = rendition.currentLocation();
            if (location) {
                updatePageStatus(location); 
            }
        });
    }

    /**
     * 지정된 EPUB File 객체를 로드하고 렌더링합니다.
     * @param {File} epubFile 로드할 EPUB File 객체
     */
    async function loadBook(epubFile) {
        if (!epubFile) return;

        fileNameDisplay.textContent = epubFile.name;

        // 기존 렌더링 정리
        if (rendition) {
            rendition.destroy();
            rendition = null;
        }
        
        // UI 초기화 및 로딩 표시
        viewer.innerHTML = '';
        const currentLoadingMessage = document.createElement('div');
        currentLoadingMessage.id = 'loading-message';
        currentLoadingMessage.innerHTML = `${epubFile.name} 파일을 불러오는 중입니다...`;
        viewer.appendChild(currentLoadingMessage);
        
        bookTitleElement.textContent = `현재 로드된 책: 로딩 중...`;
        pageStatus.textContent = '';

        try {
            book = new ePub(epubFile);

            // 페이지 모드로 고정
            const flow = "paginated";
            const spread = "none";

            // 렌더링 인스턴스 생성
            rendition = book.renderTo(viewer, {
                width: "100%", 
                height: "100%", 
                method: "default",
                flow: flow, // Paginated 모드로 고정
                spread: spread 
            });
            
            setupRenditionListeners();

            await rendition.display();

            // 로딩 메시지 숨기기
            if (viewer.contains(currentLoadingMessage)) {
                viewer.removeChild(currentLoadingMessage);
            }
            
            // 책 제목 업데이트
            book.loaded.metadata.then(metadata => {
                const title = metadata.title || epubFile.name;
                bookTitleElement.textContent = `현재 로드된 책: ${title}`;
            }).catch(e => {
                bookTitleElement.textContent = `현재 로드된 책: 제목을 가져올 수 없음 (${epubFile.name})`;
                console.error("메타데이터 로드 실패:", e);
            });

        } catch (error) {
            console.error("EPUB 로드 및 렌더링 오류:", error);
            const errorElement = viewer.querySelector('#loading-message') || currentLoadingMessage;
            errorElement.innerHTML = `EPUB 파일을 불러오는 데 실패했습니다.<br>파일이 유효한지 확인하세요.`;
            errorElement.style.color = '#CC0000';
            bookTitleElement.textContent = `현재 로드된 책: 오류 발생`;
            fileNameDisplay.textContent = '선택된 파일 없음';
        }
    }

    // 파일 입력 변경 이벤트 리스너
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            if (file.name.endsWith('.epub')) {
                loadBook(file); // File 객체를 loadBook 함수로 전달
            } else {
                showCustomAlert('EPUB 파일(.epub)만 업로드할 수 있습니다.');
                fileInput.value = ''; // 파일 입력 초기화
            }
        }
    });

    // ====================================
    // 3. PC 키보드 & 모바일 스와이프 제스처 (페이지 모드 전용)
    // ====================================

    // A. PC 키보드 이벤트 (화살표 키)
    window.addEventListener('keydown', (event) => {
        if (!rendition) return; 

        if (event.key === 'ArrowLeft') {
            event.preventDefault();
            rendition.prev().catch(e => console.error("이전 페이지 이동 오류 (키):", e));
        } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            rendition.next().catch(e => console.error("다음 페이지 이동 오류 (키):", e));
        }
    });

    // B. 모바일 스와이프 제스처 이벤트
    viewer.addEventListener('touchstart', (event) => {
        if (!rendition || event.touches.length !== 1) return;
        startX = event.touches[0].clientX;
    }, { passive: true }); 

    viewer.addEventListener('touchend', (event) => {
        if (!rendition) return;

        const endX = event.changedTouches[0].clientX;
        const deltaX = startX - endX; 
        
        if (Math.abs(deltaX) < SWIPE_THRESHOLD) return; 

        if (deltaX > 0) {
            // 왼쪽 스와이프 (다음 페이지)
            rendition.next().catch(e => console.error("다음 페이지 이동 오류 (스와이프):", e));
        } else if (deltaX < 0) {
            // 오른쪽 스와이프 (이전 페이지)
            rendition.prev().catch(e => console.error("이전 페이지 이동 오류 (스와이프):", e));
        }
    });
    
</script>

</body>
</html>
