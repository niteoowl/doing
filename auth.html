<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>doing! - 로그인/회원가입</title>
    <!-- Google Material Icons (Google Fonts Icons) 추가 --><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- 모바일 앱의 깔끔함을 위해 시스템 폰트 사용 --><style>
        /* 기본 스타일 및 제약 조건 반영 */
        :root {
            --color-white: #ffffff;
            --color-black: #000000;
            --color-accent: #1E90FF; /* 포인트 블루 (Dodger Blue) */
            --color-light-gray: #f5f5f5; /* 탭 버튼 배경 등 미묘한 구분을 위한 아주 연한 회색 */
            --color-medium-gray: #cccccc;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-white); /* 전체 배경 흰색 */
            display: flex;
            justify-content: center;
            align-items: center; /* 세로 중앙 정렬 */
            min-height: 100vh;
            color: var(--color-black);
            -webkit-tap-highlight-color: transparent;
            /* === 수정: 스크롤바 공간을 항상 예약하여 레이아웃 밀림 방지 === */
            overflow-y: scroll; 
        }

        #app-container {
            width: 100%; /* 화면 전체 너비 사용 */
            max-width: 420px; /* 콘텐츠 최대 너비 유지 (모바일 앱 느낌) */
            background-color: var(--color-white); /* 컨테이너 배경 흰색 */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            min-height: 100vh; /* 전체 화면 채우기 */
            padding: 2rem 1.5rem; /* 상하 여백, 좌우는 조금 남김 */
            justify-content: center; /* 내부 콘텐츠 중앙 정렬 */
        }

        /* 헤더 스타일 (로고) */
        .header-title {
            font-size: 3rem;
            font-weight: 800;
            color: var(--color-accent);
            letter-spacing: -2px;
            text-align: center;
            margin-bottom: 2.5rem;
        }

        /* 탭 토글 버튼 컨테이너 */
        .tab-toggle-container {
            display: flex;
            background-color: var(--color-light-gray); /* 탭 배경만 연한 회색 */
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 2rem;
            position: relative;
        }

        .tab-toggle-button {
            flex: 1;
            padding: 0.75rem 0;
            border: none;
            background-color: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #777;
            cursor: pointer;
            transition: color 0.3s ease;
            z-index: 2;
            position: relative;
        }

        .tab-toggle-button.active {
            color: var(--color-black);
        }

        /* 토글 애니메이션을 위한 슬라이더 */
        #tab-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            height: calc(100% - 8px);
            width: calc(50% - 4px);
            background-color: var(--color-white); /* 슬라이더 배경 흰색 */
            border-radius: 8px;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        
        /* 폼 컨테이너 */
        .form-container {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .form-container.hidden {
            display: none;
            opacity: 0;
            height: 0;
            overflow: hidden;
        }
        
        /* 입력 필드 스타일 */
        .input-group {
            position: relative; /* 비밀번호 토글 버튼을 위한 기준점 */
            margin-bottom: 1.25rem;
        }

        .auth-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--color-medium-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            outline: none;
        }

        .auth-input:focus {
            border-color: var(--color-accent);
        }

        /* 비밀번호 토글 버튼 스타일 */
        .password-toggle {
            position: absolute;
            right: 0.2rem; /* 입력 필드 안쪽으로 더 넣기 */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.75rem; /* 더 큰 터치 영역 확보 */
            color: #777;
            line-height: 1;
            z-index: 5;
            /* transition 제거: 클릭 시 어떠한 시각적 효과도 없도록 */
        }
        
        /* Material Icon 스타일 */
        .password-toggle i.material-icons {
            font-size: 24px; /* 아이콘 크기 */
            line-height: 1;
            display: block;
            color: currentColor; /* 부모 버튼의 색상을 따르도록 설정 */
        }

        .password-toggle:hover {
            color: var(--color-black);
        }

        /* 액션 버튼 (로그인/회원가입) */
        .action-button {
            width: 100%;
            padding: 1rem;
            background-color: var(--color-accent);
            color: var(--color-white);
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease, background-color 0.1s ease;
            margin-top: 1rem;
        }

        /* [일반 버튼] '누르면 크기 변화 효과' (사용자 요청에 따라 scale(0.97) 유지) */
        .interactive:active {
            transform: scale(0.97); /* 누르면 작아지는 효과 */
            opacity: 0.9; /* 투명도를 0.9로 설정하여 깔끔한 시각적 피드백 유지 */
        }
        
        /* [비밀번호 토글 버튼] '크기 변화 효과' 및 '색상 변화 효과' 완전히 제거 */
        .password-toggle.interactive:active {
            /* 어떠한 transform 또는 color 변화도 없이 원래 상태 유지 */
            transform: translateY(-50%) scale(1); /* 위치/크기 고정 */
            opacity: 1; /* 투명도 고정 */
            color: #777; /* 기본 색상 고정 (hover 시 검정으로) */
        }
        
        /* 모바일 화면 높이 조정 */
        @media (max-width: 420px) {
            #app-container {
                min-height: 100vh;
                height: 100%;
                padding-left: 1.5rem; /* 좌우 패딩 유지 */
                padding-right: 1.5rem;
            }
        }

        /* 모달 팝업 스타일 수정: 전체 화면 고정, 배경 오버레이, 중앙 정렬 */
        #modal {
            position: fixed; /* 화면에 고정 */
            top: 0; 
            left: 0; 
            width: 100vw; /* 뷰포트 전체 너비 */
            height: 100vh; /* 뷰포트 전체 높이 */
            background-color: rgba(0, 0, 0, 0.4); /* 반투명 검정색 오버레이 */
            display: none; /* 기본 숨김 */
            justify-content: center; 
            align-items: center; 
            z-index: 100; /* 다른 콘텐츠 위에 표시 */
        }
        .modal-content {
            background-color: var(--color-white); 
            padding: 1.5rem; 
            border-radius: 16px; 
            width: 90%; /* 모달 콘텐츠의 너비 */
            max-width: 300px; /* 최대 너비 제한 */
            text-align: center; 
            transform: scale(0.9); 
            opacity: 0; 
            transition: transform 0.2s ease, opacity 0.2s ease;
            /* 그림자 강화: 더 블러하고 색상 진하게 */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); 
        }
        .modal-title {
            font-size: 1.2rem; 
            font-weight: 700; 
            color: var(--color-black); 
            margin-bottom: 0.75rem;
        }
        .modal-text {
            color: #555; 
            margin-bottom: 1.5rem;
        }
        .modal-close-button {
            padding: 0.75rem 1.5rem; 
            background-color: var(--color-accent); 
            color: var(--color-white); 
            border: none; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="app-container">
    <h1 class="header-title">doing!</h1>

    <!-- 탭 토글 버튼 --><div class="tab-toggle-container">
        <div id="tab-slider"></div>
        <button id="login-tab" class="tab-toggle-button active" onclick="switchTab('login')">로그인</button>
        <button id="register-tab" class="tab-toggle-button" onclick="switchTab('register')">회원가입</button>
    </div>

    <!-- 로그인 폼 --><div id="login-form" class="form-container">
        <div class="input-group">
            <input type="email" id="login-email" class="auth-input" placeholder="이메일 주소" required>
        </div>
        
        <!-- 비밀번호 입력 그룹 (토글 버튼 추가) --><div class="input-group">
            <input type="password" id="login-password" class="auth-input" placeholder="비밀번호" required>
            <button type="button" class="password-toggle interactive" onclick="togglePasswordVisibility('login-password', this)">
                <!-- 아이콘은 JS에서 초기화됩니다. --><div id="toggle-icon-login"></div>
            </button>
        </div>
        
        <button id="login-button" class="action-button interactive" onclick="handleAuth('login')">
            로그인
        </button>
    </div>

    <!-- 회원가입 폼 --><div id="register-form" class="form-container hidden">
        <div class="input-group">
            <input type="email" id="register-email" class="auth-input" placeholder="이메일 주소" required>
        </div>
        <div class="input-group">
            <input type="text" id="register-nickname" class="auth-input" placeholder="사용자 이름 (닉네임)" required>
        </div>
        
        <!-- 비밀번호 입력 그룹 (토글 버튼 추가) --><div class="input-group">
            <input type="password" id="register-password" class="auth-input" placeholder="비밀번호 (6자 이상)" required>
            <button type="button" class="password-toggle interactive" onclick="togglePasswordVisibility('register-password', this)">
                <div id="toggle-icon-register"></div>
            </button>
        </div>
        
        <!-- 비밀번호 확인 입력 그룹 (토글 버튼 추가) --><div class="input-group">
            <input type="password" id="register-confirm-password" class="auth-input" placeholder="비밀번호 확인" required>
            <button type="button" class="password-toggle interactive" onclick="togglePasswordVisibility('register-confirm-password', this)">
                <div id="toggle-icon-confirm"></div>
            </button>
        </div>
        
        <button id="register-button" class="action-button interactive" onclick="handleAuth('register')">
            회원가입
        </button>
    </div>
</div>

<!-- 모달 팝업 구조 (메시지 박스 용도) --><div id="modal">
    <div class="modal-content">
        <h3 class="modal-title" id="modal-title"></h3>
        <p class="modal-text" id="modal-text"></p>
        <button class="modal-close-button interactive" onclick="hideModal()">확인</button>
    </div>
</div>

<script type="module">
    // Firebase SDK Import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        setPersistence,
        browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- Google Material Icon HTML 정의 ---
    // Eye Icon (비밀번호 보이기): Material Icon 'visibility'
    const EYE_ICON_HTML = '<i class="material-icons">visibility</i>';

    // Eye Off Icon (비밀번호 숨기기): Material Icon 'visibility_off'
    const EYE_OFF_ICON_HTML = '<i class="material-icons">visibility_off</i>';
    
    // --- Firebase 설정 및 초기화 ---
    // 사용자 제공 설정 또는 환경 변수 사용
    const userFirebaseConfig = {
        apiKey: "AIzaSyBMowSIHMdz69dYY-mAW8l6VjKxBW54SfU",
        authDomain: "doing-a.firebaseapp.com",
        projectId: "doing-a",
        storageBucket: "doing-a.firebasestorage.app",
        messagingSenderId: "24279439955",
        appId: "1:24279439955:web:2bf5c965de1b0a236884a6",
        measurementId: "G-VJ5YQRGNE3"
    };

    // 환경 변수 우선 사용 (필수 조건)
    const firebaseConfig = typeof __firebase_config !== 'undefined' && JSON.parse(__firebase_config).apiKey 
        ? JSON.parse(__firebase_config) 
        : userFirebaseConfig;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // 인증 세션 지속성 설정 (선택 사항이지만 권장)
    setPersistence(auth, browserSessionPersistence);


    // --- UI 로직 (Firebase 함수와 연결) ---
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');
    const tabSlider = document.getElementById('tab-slider');
    
    // 모달 관련 요소
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');

    /**
     * 로그인/회원가입 폼 전환 및 슬라이더 이동
     * @param {string} tabName - 'login' 또는 'register'
     */
    window.switchTab = function(tabName) {
        if (tabName === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            tabSlider.style.left = '4px';
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            loginTab.classList.remove('active');
            registerTab.classList.add('active');
            // 슬라이더가 컨테이너 너비의 정확히 50% 위치에서 시작하도록 수정
            tabSlider.style.left = `50%`;
        }
    }

    /**
     * 비밀번호 입력 필드의 가시성을 토글합니다.
     * @param {string} inputId - 비밀번호 입력 필드의 ID
     * @param {HTMLElement} buttonElement - 토글 버튼 요소
     */
    window.togglePasswordVisibility = function(inputId, buttonElement) {
        const input = document.getElementById(inputId);
        const iconContainer = buttonElement.querySelector('div');
        
        if (input.type === 'password') {
            input.type = 'text';
            iconContainer.innerHTML = EYE_OFF_ICON_HTML; // 숨김 아이콘
        } else {
            input.type = 'password';
            iconContainer.innerHTML = EYE_ICON_HTML; // 보임 아이콘
        }
    }

    // --- 인증 처리 로직 (Firebase 연동) ---

    /**
     * 인증 처리 (로그인 또는 회원가입)
     * @param {string} type - 'login' 또는 'register'
     */
    window.handleAuth = async function(type) {
        // ... (인증 로직은 변경 없음)
        if (type === 'login') {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!email || !password) {
                showModal('오류', '이메일과 비밀번호를 모두 입력해주세요.');
                return;
            }
            
            try {
                // Firebase 로그인
                await signInWithEmailAndPassword(auth, email, password);
                showModal('로그인 성공', '메인 페이지로 이동합니다.');
                // 로그인 성공 시 /로 이동
                setTimeout(() => { window.location.href = '/'; }, 1000);

            } catch (error) {
                let errorMessage = '로그인에 실패했습니다. 이메일 또는 비밀번호를 확인해주세요.';
                console.error("Firebase Login Error:", error.code, error.message);
                if (error.code === 'auth/user-not-found') {
                    errorMessage = '존재하지 않는 사용자입니다.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = '비밀번호가 일치하지 않습니다.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '유효하지 않은 이메일 주소 형식입니다.';
                }
                showModal('로그인 오류', errorMessage);
            }

        } else if (type === 'register') {
            const email = document.getElementById('register-email').value.trim();
            const nickname = document.getElementById('register-nickname').value.trim(); // 닉네임은 현재 Firebase Auth에서는 직접 사용되지 않지만 입력받음
            const password = document.getElementById('register-password').value.trim();
            const confirmPassword = document.getElementById('register-confirm-password').value.trim();
            
            if (!email || !nickname || !password || !confirmPassword) {
                showModal('오류', '모든 필수 정보를 입력해주세요.');
                return;
            }

            if (password.length < 6) {
                showModal('오류', '비밀번호는 6자 이상이어야 합니다.');
                return;
            }

            if (password !== confirmPassword) {
                showModal('오류', '비밀번호 확인이 일치하지 않습니다.');
                return;
            }

            try {
                // Firebase 회원가입
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // 회원가입 성공 후 닉네임 설정 (선택 사항)
                // await updateProfile(userCredential.user, { displayName: nickname });
                
                showModal('회원가입 성공', '회원가입이 완료되었습니다. 메인 페이지로 이동합니다.');
                // 회원가입 성공 시 /로 이동
                setTimeout(() => { window.location.href = '/'; }, 1000);

            } catch (error) {
                let errorMessage = '회원가입에 실패했습니다.';
                console.error("Firebase Register Error:", error.code, error.message);
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = '이미 사용 중인 이메일 주소입니다.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '유효하지 않은 이메일 주소 형식입니다.';
                }
                showModal('회원가입 오류', errorMessage);
            }
        }
    }

    // --- 모달 팝업 함수 (window에 바인딩되어 HTML onclick 접근 가능) ---
    window.showModal = function(title, text) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        modal.style.display = 'flex';
        // 애니메이션 클래스 추가
        setTimeout(() => {
            modal.querySelector('.modal-content').style.transform = 'scale(1)';
            modal.querySelector('.modal-content').style.opacity = '1';
        }, 10); 
    }

    window.hideModal = function() {
        // 애니메이션 클래스 제거
        modal.querySelector('.modal-content').style.transform = 'scale(0.9)';
        modal.querySelector('.modal-content').style.opacity = '0';
        // 애니메이션 완료 후 display: none 처리
        setTimeout(() => {
            modal.style.display = 'none';
        }, 200); 
    }
    
    // --- 초기화 로직 ---
    function initializeIcons() {
        // SVG 대신 Material Icon HTML 사용
        document.getElementById('toggle-icon-login').innerHTML = EYE_ICON_HTML;
        document.getElementById('toggle-icon-register').innerHTML = EYE_ICON_HTML;
        document.getElementById('toggle-icon-confirm').innerHTML = EYE_ICON_HTML;
    }

    // 초기 로드 시 실행
    window.addEventListener('load', () => {
        initializeIcons();
        const appContainer = document.getElementById('app-container');
        appContainer.style.minHeight = `${window.innerHeight}px`;
    });
    // 화면 크기 변경 시 높이 조정
    window.addEventListener('resize', () => {
        const appContainer = document.getElementById('app-container');
        appContainer.style.minHeight = `${window.innerHeight}px`;
    });
</script>
</body>
</html>
